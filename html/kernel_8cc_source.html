<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Starburst: kernel/kernel.cc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Starburst
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('kernel_8cc.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">kernel/kernel.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="kernel_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;<a class="code" href="helix__config_8h.html" title="Configuration of the OS.">sys/helix_config.h</a>&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;<a class="code" href="kernel_8h.html" title="Declaration of all kernel functions.">sys/kernel.h</a>&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;<a class="code" href="io_8h.html" title="Declaration of all I/O function, types and address macros.">sys/io.h</a>&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="malloc_8h.html">malloc.h</a>&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;<a class="code" href="daemons_8h.html" title="All daemon definitions.">daemons.h</a>&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;<a class="code" href="signal_8h.html">signal.h</a>&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="code" href="pthread_8h.html" title="POSIX Pthread standard implementation.">pthread.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;<a class="code" href="stdlib_8h.html">stdlib.h</a>&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="code" href="trace_8h.html" title="Tracing of process execution and phases.">trace.h</a>&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;<a class="code" href="mc_8h.html" title="Implementation of a memory consistency model.">mc.h</a>&gt;</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">/*! \file</span>
<a name="l00016"></a>00016 <span class="comment"> * \brief Implementation of all kernel functions.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * Note that all function starting with k should only be called from within the kernel context: priviledged mode, in a syscall.</span>
<a name="l00019"></a>00019 <span class="comment"> * Do not do a syscall from within a syscall.</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="kernel_8cc.html#acd9f0f58b087afb077290bd73ef4c648">00022</a> <span class="preprocessor">#define DBLED_ALIVE     0</span>
<a name="l00023"></a><a class="code" href="kernel_8cc.html#ae209adfd4a579b0314c1eeef436d22a4">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define DBLED_INIT      1</span>
<a name="l00024"></a><a class="code" href="kernel_8cc.html#aa28741aad188fa566e089c3ea540a906">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define DBLED_SCHEDULE  2</span>
<a name="l00025"></a><a class="code" href="kernel_8cc.html#a38a287b0851d123e1e31072fcd03008d">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define DBLED_PANIC     3</span>
<a name="l00026"></a><a class="code" href="kernel_8cc.html#a669e9dd46ec1bdacc6cd2fbd9b530a70">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define DBLED_NEWPROC   4</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a>00028 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00029"></a><a class="code" href="kernel_8cc.html#aafee7403c191c45dd3a07b64954f828a">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUG_ON(led)   led_on(led)</span>
<a name="l00030"></a><a class="code" href="kernel_8cc.html#ad7b6b6cb649dc9d9560c68b1d94464f9">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUG_OFF(led)  led_off(led)</span>
<a name="l00031"></a><a class="code" href="kernel_8cc.html#a3920226e3e0e7a84cd56680e03f96b94">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUG_ALLOFF()  leds_value(0)</span>
<a name="l00032"></a><a class="code" href="kernel_8cc.html#aa814952312a46824ecd43f85b6d45157">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUG(str,a...) printk(&quot;KERNEL %d: &quot; str &quot;\n&quot;,GetProcID(),##a)</span>
<a name="l00033"></a><a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define DEBUG0(a...)    do{if(GetProcID()==0)DEBUG(a);}while(0)</span>
<a name="l00034"></a><a class="code" href="kernel_8cc.html#a5918a433e654d957a62f8f9d0839d0b5">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define TDEBUG_SIZE 13</span>
<a name="l00035"></a><a class="code" href="kernel_8cc.html#a77b4d1550e6990d959376de008f509ed">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define TDEBUG(a...)                                                                                \</span>
<a name="l00036"></a>00036 <span class="preprocessor">    do{                                                                                             \</span>
<a name="l00037"></a>00037 <span class="preprocessor">        struct timeval now;                                                                         \</span>
<a name="l00038"></a>00038 <span class="preprocessor">        const unsigned int  ts=(1&lt;&lt;TDEBUG_SIZE)*GetProcID(),                                        \</span>
<a name="l00039"></a>00039 <span class="preprocessor">                            ts_mask=((1&lt;&lt;TDEBUG_SIZE)*NUM_PROCESSORS-1)&amp;~((1&lt;&lt;TDEBUG_SIZE)-1);      \</span>
<a name="l00040"></a>00040 <span class="preprocessor">        while(gettimeofday(&amp;now,NULL)==0&amp;&amp;(now.tv_usec&amp;ts_mask)!=ts);                               \</span>
<a name="l00041"></a>00041 <span class="preprocessor">        DEBUG(a);                                                                                   \</span>
<a name="l00042"></a>00042 <span class="preprocessor">    }while(0)</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a>00044 <span class="preprocessor">#else</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#define DEBUG_ON(led)</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#define DEBUG_OFF(led)</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#define DEBUG_ALLOFF()</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#define DEBUG(str,a...)</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#define DEBUG0(a...)</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#define TDEBUG(a...)</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">00053</a> <span class="preprocessor">#define ASSIGN_CONST_PTR(type,var,val)  *(type**)&amp;(var)=(val)</span>
<a name="l00054"></a><a class="code" href="kernel_8cc.html#a017d3e8af0a7f0e5266f61ac26fadd66">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define kSetOSState(state)              *(os_state_t*)&amp;os_state=state</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l00057"></a><a class="code" href="kernel_8cc.html#a0d73b8a648a1501b4a09c11bfd9c819c">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define kIsInSigHandler(pt)             (pt-&gt;sig_havetriggered!=0)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#define kIsInSigHandler(pt)             false</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">00062</a> <span class="preprocessor">#define td_proc (&amp;kernel_context-&gt;proc_table[0])</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#ifdef __cplusplus</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00067"></a>00067 <span class="preprocessor">#endif</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a>00069 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a5eda2256972d4e67ab045cb3ebfa4ecf">kInitSignalContext</a>(<a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>* sig_context, <a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>* proc_context,<span class="keywordtype">char</span>* triggered,<span class="keywordtype">int</span>* havetriggered);
<a name="l00070"></a>00070 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a623caf4cba9f8fe345d3412fe457908a">kResetSignalContext</a>(<a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>* sig_context);
<a name="l00071"></a>00071 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a7b094927158396795fa3d560753d02b6" title="Basic initialization of the kernel.">kInitKernel</a>(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* param);
<a name="l00072"></a>00072 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#ac684d34fd7c17e04891439d2d179c78e" title="Starts the task daemon.">kStartTaskDaemon</a>(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* param);
<a name="l00073"></a>00073 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a6e5acd9d66f11151cbc5a843583cf9e7" title="Initializes the scheduler and start scheduling.">kStartScheduling</a>() <a class="code" href="info__app_8h.html#aeab68f17dc686a2f7dc72ab2b712e464">__attribute__</a> ((noreturn));
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="preprocessor">#ifdef SCHEDULING_IN_LOCAL_RAM</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">void</span>* <a class="code" href="kernel_8cc.html#a1de4c077d031ef840643d2158c3d649c">_text_schedule</a>;
<a name="l00077"></a>00077 <span class="keyword">extern</span> <span class="keywordtype">void</span>* <a class="code" href="kernel_8cc.html#a8154b4c44de671f04c932bcb760ee158">_text_schedule_end</a>;
<a name="l00078"></a>00078 <span class="keyword">extern</span> <span class="keywordtype">void</span>* <a class="code" href="kernel_8cc.html#ac0f851485b54bb272ad50cb7564d700b">_text_schedule_base</a>;
<a name="l00079"></a>00079 <span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="preprocessor">#ifdef STACK_CHECK</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">void</span>* _stack_end;
<a name="l00083"></a>00083 <span class="preprocessor">#endif</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a>00085 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="cheap_8cc.html#a2979da41734d1ea92d850b7cc25c52b5">_ddrbase</a>;
<a name="l00086"></a>00086 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="kernel_8cc.html#aa3dffd73b983369f8f6e4b0ac7bb22d0">_ddrend</a>;
<a name="l00087"></a><a class="code" href="kernel_8cc.html#a84f421f490b8753b261209ac5b8485de">00087</a> <span class="preprocessor">#define IS_VALID_DDR_PTR(p) ((uintptr_t)(p)&gt;=(uintptr_t)(&amp;_ddrbase)&amp;&amp;(uintptr_t)(p)&lt;(uintptr_t)(&amp;_ddrend))</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00089"></a>00089 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00090"></a>00090 <span class="comment"></span><span class="comment">// Types</span><span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00092"></a>00092 <span class="comment"></span>
<a name="l00093"></a><a class="code" href="kernel_8cc.html#adb8d91529f94de9573a88c3b8514ac6f">00093</a> <span class="preprocessor">#define STACK_PROTECTION_VALUE  0xdeadbeef</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a>00095 <span class="preprocessor">#ifdef KERNEL_CONTEXT_LOCAL</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="comment">/*! \brief The one and only kernel context */</span>
<a name="l00097"></a>00097 <a class="code" href="structkernel__context__t.html" title="All information of the kernel.">kernel_context_t</a> kernel_contexts[1];
<a name="l00098"></a>00098 <span class="preprocessor">#else</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="comment">/*! \brief All kernel contexts, located in shared memory */</span>
<a name="l00100"></a>00100 <a class="code" href="structkernel__context__t.html" title="All information of the kernel.">kernel_context_t</a> kernel_contexts[NUM_PROCESSORS] <a class="code" href="info__app_8h.html#aeab68f17dc686a2f7dc72ab2b712e464">__attribute__</a> ((section (<span class="stringliteral">&quot;.bss.kcontext&quot;</span>),aligned(<a class="code" href="helix__config_8h.html#ac946bd02ab86555c1a7700dbfd9d30bf" title="Number of bytes to align data to in order to avoid cache hazards.">CACHELINE_ALIGN</a>)));
<a name="l00101"></a>00101 <span class="preprocessor">#endif</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">/*! \brief The name of the kernel to print during boot */</span>
<a name="l00104"></a>00104 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* kernel_name <a class="code" href="info__app_8h.html#aeab68f17dc686a2f7dc72ab2b712e464">__attribute__</a>((unused)) = <a class="code" href="helix__config_8h.html#a69e7bc540e11270eeecd410c206297fe" title="Name of the kernel.">KERNEL_NAME</a>;
<a name="l00105"></a>00105 <span class="comment"></span>
<a name="l00106"></a>00106 <span class="comment">/*! \brief Flags to influence scheduling */</span>
<a name="l00107"></a><a class="code" href="structsch__t.html">00107</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00108"></a><a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">00108</a>     <a class="code" href="structpthread__sch__t.html">pthread_sch_t</a>* <a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>;
<a name="l00109"></a><a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">00109</a>     <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>;
<a name="l00110"></a><a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">00110</a>     <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">have_work</a>;
<a name="l00111"></a><a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">00111</a>     <span class="keywordtype">int</span> <a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">was_idle</a>;
<a name="l00112"></a>00112 <span class="preprocessor">#ifdef SCHEDULE_SLOTS</span>
<a name="l00113"></a><a class="code" href="structsch__t.html#ad37f09582d4fc75ff893686de8816a2a">00113</a> <span class="preprocessor"></span>    <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="structsch__t.html#ad37f09582d4fc75ff893686de8816a2a">skip_taskdaemon</a>;
<a name="l00114"></a><a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">00114</a>     <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>;
<a name="l00115"></a>00115 <span class="preprocessor">#endif</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>} <a class="code" href="structsch__t.html" title="Flags to influence scheduling.">sch_t</a>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="keyword">extern</span> <a class="code" href="structsch__t.html" title="Flags to influence scheduling.">sch_t</a> <a class="code" href="kernel_8cc.html#a6afe81513cad22ce2ec248b31fbf5f41">sch</a>;
<a name="l00119"></a>00119 
<a name="l00120"></a><a class="code" href="kernel_8cc.html#a6646eba88004157f0b0e52925526488d">00120</a> <span class="preprocessor">#define DID_WORK_NO     0</span>
<a name="l00121"></a><a class="code" href="kernel_8cc.html#a2c73da0c8100fb61b4e9ed91ec30134d">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define DID_WORK_MAYBE  1</span>
<a name="l00122"></a><a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define DID_WORK_YES    2</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00124"></a>00124 <span class="preprocessor">#define TRACE ((trace_t*)kGetHookTable()[HOOK_TRACE])</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00126"></a>00126 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00127"></a>00127 <span class="comment"></span><span class="comment">// newlib support</span><span class="comment"></span>
<a name="l00128"></a>00128 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="preprocessor">#include &lt;reent.h&gt;</span>
<a name="l00131"></a>00131 <span class="comment">// there is a typo in the _REENT_INIT_PTR macro:</span>
<a name="l00132"></a><a class="code" href="kernel_8cc.html#a4c740f9487e37f58a981720fcff694f0">00132</a> <span class="preprocessor">#define __sf_fake_stdio __sf_fake_stdin</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00134"></a>00134 <span class="comment">/*! \brief All impure data (as defined by newlib), reserved for kernel */</span>
<a name="l00135"></a>00135 <span class="keyword">struct </span>_reent kernel_impure_data __attribute__ ((section (&quot;.bss.proc&quot;)));<span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">/*! \brief Pointer to global_impure_data */</span>
<a name="l00137"></a><a class="code" href="kernel_8cc.html#aea5a41e11c90591e0e82309d15680c19">00137</a> <span class="keyword">struct </span>_reent *_CONST __ATTRIBUTE_IMPURE_PTR__ <a class="code" href="kernel_8cc.html#aea5a41e11c90591e0e82309d15680c19" title="Pointer to global_impure_data.">_kernel_impure_ptr</a> = &amp;kernel_impure_data;
<a name="l00138"></a>00138 <span class="comment"></span>
<a name="l00139"></a>00139 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00140"></a>00140 <span class="comment"></span><span class="comment">// Kernel lifetime</span><span class="comment"></span>
<a name="l00141"></a>00141 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00142"></a>00142 <span class="comment"></span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">/*!</span>
<a name="l00146"></a>00146 <span class="comment"> * \brief Entry point of C-code of the kernel</span>
<a name="l00147"></a>00147 <span class="comment"> *</span>
<a name="l00148"></a>00148 <span class="comment"> * After initialization of crt0.S and crtbegin.S, this function is called.</span>
<a name="l00149"></a>00149 <span class="comment"> * It will handle all initialization routines of the kernel and will eventually</span>
<a name="l00150"></a>00150 <span class="comment"> * start the task daemon.</span>
<a name="l00151"></a>00151 <span class="comment"> *</span>
<a name="l00152"></a>00152 <span class="comment"> * The master core will usually be invoked without additional arguments, a</span>
<a name="l00153"></a>00153 <span class="comment"> * slave core will receive a #kernel_boot_param_t* that contains a</span>
<a name="l00154"></a>00154 <span class="comment"> * reference to a mailbox to notify a successful boot.</span>
<a name="l00155"></a>00155 <span class="comment"> *</span>
<a name="l00156"></a>00156 <span class="comment"> * \param arg NULL or #kernel_boot_param_t*</span>
<a name="l00157"></a>00157 <span class="comment"> */</span>
<a name="l00158"></a>00158 <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a0ec6a8880bbbb1ea06e2fe706e0243e5" title="Entry point of C-code of the kernel.">kBoot</a>(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* arg) <a class="code" href="info__app_8h.html#aeab68f17dc686a2f7dc72ab2b712e464">__attribute__</a> ((noreturn));
<a name="l00159"></a><a class="code" href="kernel_8cc.html#a0ec6a8880bbbb1ea06e2fe706e0243e5">00159</a> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a0ec6a8880bbbb1ea06e2fe706e0243e5" title="Entry point of C-code of the kernel.">kBoot</a>(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* arg){
<a name="l00160"></a>00160     <a class="code" href="kernel_8cc.html#a017d3e8af0a7f0e5266f61ac26fadd66">kSetOSState</a>(<a class="code" href="kernel_8h.html#a377ea6c9edb9a0cb4c553bd158580fbea0753d1a5e1542769dbede19d9514edca">OS_BOOT</a>);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a> param;
<a name="l00163"></a>00163     param.<a class="code" href="structkernel__boot__param__t.html#a02eabea0f112079840971f63387ba3ef" title="pointer to a mailbox to signal a successful boot">notify_booted</a>=NULL;
<a name="l00164"></a>00164     param.<a class="code" href="structkernel__boot__param__t.html#ac5ed1f7b772aed377c8784a1e5cb2985" title="user-defined argument to be passed to the task daemon">arg</a>=NULL;
<a name="l00165"></a>00165     <span class="comment">// copy to local variable; InitKernel will overwite the _fifomem</span>
<a name="l00166"></a>00166     <span class="keywordflow">if</span>(arg!=NULL)
<a name="l00167"></a>00167         param=*((<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>*)arg);
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <a class="code" href="kernel_8cc.html#a3920226e3e0e7a84cd56680e03f96b94">DEBUG_ALLOFF</a>();
<a name="l00170"></a>00170     <a class="code" href="InitHardware_8cc.html#ac0f10bdbaccf1c911e15cc466bb81e1c" title="Call to initialize hardware, such as network routes to essential peripherals.">InitHardware</a>(param.<a class="code" href="structkernel__boot__param__t.html#ac5ed1f7b772aed377c8784a1e5cb2985" title="user-defined argument to be passed to the task daemon">arg</a>);
<a name="l00171"></a>00171     <a class="code" href="kernel_8cc.html#aafee7403c191c45dd3a07b64954f828a">DEBUG_ON</a>(<a class="code" href="kernel_8cc.html#acd9f0f58b087afb077290bd73ef4c648">DBLED_ALIVE</a>);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <a class="code" href="kernel_8cc.html#aafee7403c191c45dd3a07b64954f828a">DEBUG_ON</a>(<a class="code" href="kernel_8cc.html#ae209adfd4a579b0314c1eeef436d22a4">DBLED_INIT</a>);
<a name="l00174"></a>00174     <a class="code" href="kernel_8cc.html#a7b094927158396795fa3d560753d02b6" title="Basic initialization of the kernel.">kInitKernel</a>(&amp;param);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <a class="code" href="kernel_8cc.html#ac684d34fd7c17e04891439d2d179c78e" title="Starts the task daemon.">kStartTaskDaemon</a>(&amp;param);
<a name="l00177"></a>00177     <a class="code" href="kernel_8cc.html#ad7b6b6cb649dc9d9560c68b1d94464f9">DEBUG_OFF</a>(<a class="code" href="kernel_8cc.html#ae209adfd4a579b0314c1eeef436d22a4">DBLED_INIT</a>);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <a class="code" href="kernel_8cc.html#a6e5acd9d66f11151cbc5a843583cf9e7" title="Initializes the scheduler and start scheduling.">kStartScheduling</a>();
<a name="l00180"></a>00180     <span class="comment">// unreachable</span>
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="kernel_8cc.html#adbd61a5fbc35c76f4bcf9eccb289d2ee">00183</a> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#adbd61a5fbc35c76f4bcf9eccb289d2ee">Disclaimer</a>(){
<a name="l00184"></a>00184     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;Built for %d processors, running %d processes each.\n&quot;</span>,NUM_PROCESSORS,<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>);
<a name="l00185"></a>00185 <span class="preprocessor">#ifdef KERNEL_BUILD_FLAGS</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;Kernel build flags: &quot;</span> KERNEL_BUILD_FLAGS <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00187"></a>00187 <span class="preprocessor">#endif</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span><span class="preprocessor">#if defined(SVNREV) &amp;&amp; SVNREV&gt;0</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;svn:r&quot;</span> <a class="code" href="api_8h.html#a4689212d5a549893cabb9d7782eecfb6">STRINGIFY</a>(SVNREV) <span class="stringliteral">&quot; &quot;</span>);
<a name="l00190"></a>00190 <span class="preprocessor">#endif</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">#ifdef EDKVERSION</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;edk:&quot;</span> EDKVERSION <span class="stringliteral">&quot; &quot;</span>);
<a name="l00193"></a>00193 <span class="preprocessor">#endif</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor">#ifdef BUILDDATE</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;date:&quot;</span> BUILDDATE <span class="stringliteral">&quot; &quot;</span>);
<a name="l00196"></a>00196 <span class="preprocessor">#endif</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span><span class="preprocessor">#ifdef GCCVERSION</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;cc:&quot;</span> GCCVERSION <span class="stringliteral">&quot; &quot;</span>);
<a name="l00199"></a>00199 <span class="preprocessor">#endif</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span><span class="preprocessor">#ifdef _NEWLIB_VERSION</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;newlib:&quot;</span> _NEWLIB_VERSION <span class="stringliteral">&quot; &quot;</span>);
<a name="l00202"></a>00202 <span class="preprocessor">#endif</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;\nCopyleft Jochem Rutgers, 2014\n\n&quot;</span>);
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="preprocessor">#ifdef KERNEL_CHECKSUM</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _chksum <a class="code" href="info__app_8h.html#aeab68f17dc686a2f7dc72ab2b712e464">__attribute__</a>((unused,section(<span class="stringliteral">&quot;.chksum&quot;</span>)));
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="keyword">static</span> <span class="keywordtype">void</span> kChecksum(){
<a name="l00210"></a>00210 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;...\nChecksum over &quot;</span>);
<a name="l00212"></a>00212     <a class="code" href="io_8h.html#a4d51f849d2b10be5def52c47ae9635e6">_putp</a>(&amp;_ddrbase);
<a name="l00213"></a>00213     <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;-&quot;</span>);
<a name="l00214"></a>00214     <a class="code" href="io_8h.html#a4d51f849d2b10be5def52c47ae9635e6">_putp</a>(&amp;_chksum);
<a name="l00215"></a>00215     <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot; is &quot;</span>);
<a name="l00216"></a>00216     <a class="code" href="io_8h.html#aa361adef830a6a8f881c4da6d514226e">_putn</a>(_chksum);
<a name="l00217"></a>00217     <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;: &quot;</span>);
<a name="l00218"></a>00218 <span class="preprocessor">#endif</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span>
<a name="l00220"></a>00220     <span class="keywordflow">if</span>(_chksum==0){
<a name="l00221"></a>00221 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>        <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;ignored\n&quot;</span>);
<a name="l00223"></a>00223 <span class="preprocessor">#endif</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *w=&amp;_ddrbase;
<a name="l00228"></a>00228     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sum=0;
<a name="l00229"></a>00229     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=(<span class="keywordtype">int</span>)(((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)&amp;_chksum-(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)&amp;_ddrbase)/<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>))-1;i&gt;=0;i--)
<a name="l00230"></a>00230         sum+=w[i];
<a name="l00231"></a>00231     <span class="keywordflow">if</span>(sum!=_chksum){
<a name="l00232"></a>00232         <span class="comment">// invalid checksum</span>
<a name="l00233"></a>00233         <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;Invalid checksum &quot;</span>);
<a name="l00234"></a>00234         <a class="code" href="io_8h.html#aa361adef830a6a8f881c4da6d514226e">_putn</a>(sum);
<a name="l00235"></a>00235         <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00236"></a>00236         <a class="code" href="kernel_8h.html#a07f2e6566f212b6272752685f3579ff4">kReset</a>();
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
<a name="l00240"></a>00240         <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;ok\n...&quot;</span>);
<a name="l00241"></a>00241 <span class="preprocessor">#endif</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span>}
<a name="l00243"></a>00243 <span class="preprocessor">#endif</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>
<a name="l00245"></a>00245 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00246"></a><a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">00246</a> <span class="preprocessor"></span><span class="preprocessor">#define KERNEL_PRINT_PROGRESS       if(GetProcID()==0)outbyte(kernel_name[init_progress++])</span>
<a name="l00247"></a><a class="code" href="kernel_8cc.html#a0630a11dd00b48b8d2b1d2a4a1dfa9de">00247</a> <span class="preprocessor"></span><span class="preprocessor">#define KERNEL_PRINT_PROGRESS_END   if(GetProcID()==0)do{printk(&quot;%s\n&quot;,&amp;kernel_name[init_progress]); if(GetProcID()==0)Disclaimer();}while(0)</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#define KERNEL_PRINT_PROGRESS</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span><span class="preprocessor">#define KERNEL_PRINT_PROGRESS_END</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00253"></a>00253 <span class="comment">/*!</span>
<a name="l00254"></a>00254 <span class="comment"> * \brief Basic initialization of the kernel</span>
<a name="l00255"></a>00255 <span class="comment"> *</span>
<a name="l00256"></a>00256 <span class="comment"> * It will initialize the heaps, kernel context, and process table.</span>
<a name="l00257"></a>00257 <span class="comment"> *</span>
<a name="l00258"></a>00258 <span class="comment"> * \param param the same argument as the one main(int,char**) got</span>
<a name="l00259"></a>00259 <span class="comment"> */</span>
<a name="l00260"></a><a class="code" href="kernel_8cc.html#a7b094927158396795fa3d560753d02b6">00260</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a7b094927158396795fa3d560753d02b6" title="Basic initialization of the kernel.">kInitKernel</a>(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* param){
<a name="l00261"></a>00261     <a class="code" href="kernel_8cc.html#a017d3e8af0a7f0e5266f61ac26fadd66">kSetOSState</a>(<a class="code" href="kernel_8h.html#a377ea6c9edb9a0cb4c553bd158580fbeaa247e0b24bdbe2d47db4775c084c8ac5">OS_INIT</a>);
<a name="l00262"></a>00262 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span>    <span class="keywordtype">int</span> init_progress=0;
<a name="l00264"></a>00264 <span class="preprocessor">#endif</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span>    <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 <span class="preprocessor">#ifdef KERNEL_CHECKSUM</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>()==0)
<a name="l00269"></a>00269         kChecksum();
<a name="l00270"></a>00270 <span class="preprocessor">#endif</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>    <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="comment">// Speed up the processor: enable cache</span>
<a name="l00274"></a>00274     <a class="code" href="device_8h.html#abf308c1fbd801fa34a582467dd4ea88c" title="Initializes, invalidates and enables instruction cache (when available).">InitICache</a>();
<a name="l00275"></a>00275     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<span class="keyword">sizeof</span>(<a class="code" href="structkernel__context__t.html" title="All information of the kernel.">kernel_context_t</a>)%<a class="code" href="helix__config_8h.html#ac946bd02ab86555c1a7700dbfd9d30bf" title="Number of bytes to align data to in order to avoid cache hazards.">CACHELINE_ALIGN</a>!=0)
<a name="l00279"></a>00279         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Kernel context size not aligned to cacheline!&quot;</span>);
<a name="l00280"></a>00280     <span class="keywordflow">if</span>(((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)kernel_contexts)%<a class="code" href="helix__config_8h.html#ac946bd02ab86555c1a7700dbfd9d30bf" title="Number of bytes to align data to in order to avoid cache hazards.">CACHELINE_ALIGN</a>!=0)
<a name="l00281"></a>00281         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Kernel context not aligned to cacheline!&quot;</span>);
<a name="l00282"></a>00282 <span class="preprocessor">#endif</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">#ifdef HELP_ME_DEBUGGING</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>    <a class="code" href="device_8h.html#ac7d3ef26cf6337259a14014836c0b189" title="Invalidates (means: just drop data from cache) the complete data cache.">InvalidateDCache</a>();
<a name="l00285"></a>00285 <span class="preprocessor">#else</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>    <a class="code" href="device_8h.html#a82137fc09a1632b76b3c0347f4c2d436" title="Initializes, invalidates and enables data cache (when available).">InitDCache</a>();
<a name="l00287"></a>00287 <span class="preprocessor">#endif</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>    <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="preprocessor">#ifdef SCHEDULING_IN_LOCAL_RAM</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span>    <span class="comment">// Copy .text.schedule section from DDR to local ram.</span>
<a name="l00292"></a>00292     <span class="comment">// This should make context switching faster, because no DDR and caches are used</span>
<a name="l00293"></a>00293     <span class="keywordtype">size_t</span> _text_schedule_size=(size_t)((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)&amp;_text_schedule_end-(<span class="keywordtype">unsigned</span> int)&amp;_text_schedule);
<a name="l00294"></a>00294     <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a9a3bbe67a3a5b97327af7305f27c4d85" title="Returns the size of the local memory in bytes.">GetLocalMemSize</a>()&lt;(<span class="keywordtype">unsigned</span> int)&amp;_text_schedule_end)
<a name="l00295"></a>00295         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Local memory not large enough for scheduling code&quot;</span>);
<a name="l00296"></a>00296     memcpy(&amp;_text_schedule,&amp;_text_schedule_base,_text_schedule_size);
<a name="l00297"></a>00297 <span class="preprocessor">#endif</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>    <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="comment">// Initialize context</span>
<a name="l00301"></a>00301 <span class="preprocessor">#ifdef KERNEL_CONTEXT_LOCAL</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>=&amp;kernel_contexts[0];
<a name="l00303"></a>00303 <span class="preprocessor">#else</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>=&amp;kernel_contexts[<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>()];
<a name="l00305"></a>00305 <span class="preprocessor">#endif</span>
<a name="l00306"></a>00306 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;hooks=NULL;
<a name="l00307"></a>00307     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="comment">// Set PID to 0, so we mimic being the TaskDaemon.</span>
<a name="l00310"></a>00310     <span class="comment">// Otherwise, we cannot create processes.</span>
<a name="l00311"></a>00311     <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>,<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>);
<a name="l00312"></a>00312     <a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>-&gt;pid=0;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="comment">// newlib support: reentrancy structs</span>
<a name="l00315"></a>00315     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00316"></a>00316     _REENT_INIT_PTR(_kernel_impure_ptr);
<a name="l00317"></a>00317     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00318"></a>00318     <a class="code" href="kernel_8h.html#a69471a3ff8b448af4172f71d74bed723" title="thread-local reentrancy struct of newlib, must point to process&#39;s proc_table_t::impure_data">_impure_ptr</a>=<a class="code" href="kernel_8cc.html#aea5a41e11c90591e0e82309d15680c19" title="Pointer to global_impure_data.">_kernel_impure_ptr</a>;
<a name="l00319"></a>00319     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <span class="comment">// Initialize memory</span>
<a name="l00322"></a>00322     <a class="code" href="structHTAG.html">HEAP</a>* p=NULL;
<a name="l00323"></a>00323     <a class="code" href="malloc_8h.html#a49b2bf18a7c1d47bd863754d60f9248c">malloc_init</a>(&amp;p,<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#abd271731ba5c4910eecc3eae6992ed0f" title="heap for this processor">heap</a>,<a class="code" href="helix__config_8h.html#ad18a1fa52854d46e6849e74bb655c6c1" title="Size of per-processor heap in bytes.">PROC_HEAP</a>);
<a name="l00324"></a>00324     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00325"></a>00325     <span class="keywordflow">if</span>(!p)<a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Initialization of processor heap failed.&quot;</span>);
<a name="l00326"></a>00326     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00327"></a>00327     
<a name="l00328"></a>00328     p=NULL;
<a name="l00329"></a>00329     <a class="code" href="malloc_8h.html#a49b2bf18a7c1d47bd863754d60f9248c">malloc_init</a>(&amp;p,<a class="code" href="kernel_8h.html#ab8a0d73d46ebb6fa412e87ac205bfc03" title="Pointer to the local FIFO memory HEAP structure.">_fifomem</a>,<a class="code" href="device_8h.html#a055cc88594a49f5142b9c870c16b45d9" title="Returns the size of the FIFO memory in bytes.">GetFifoMemSize</a>()-<a class="code" href="daemons_8h.html#a4d61e10da6fc7183557b8fef05a5c87a">TASK_DAEMON_FIFO_SIZE</a>-<a class="code" href="helix__config_8h.html#ac9a14452bd118864786411a65143e7af">RING_CONSISTENCY_SIZE</a>);
<a name="l00330"></a>00330     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00331"></a>00331     <span class="keywordflow">if</span>(!p)<a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Initialization of FIFO memory heap failed.&quot;</span>);
<a name="l00332"></a>00332     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00333"></a>00333     
<a name="l00334"></a>00334     <span class="keywordflow">if</span>(!(<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;hooks=(<a class="code" href="hooks_8h.html#a60608a6e577367c4f9928747aea95b56" title="The hook-table type.">hook_t</a>*)<a class="code" href="malloc_8h.html#a5b7a84025a4335e67d2014134bb782ac">lcalloc</a>(<a class="code" href="hooks_8h.html#a6ae11be47583e8bbab3887394d6f45c5" title="Number hooks.">HOOKS</a>,<span class="keyword">sizeof</span>(<a class="code" href="hooks_8h.html#a60608a6e577367c4f9928747aea95b56" title="The hook-table type.">hook_t</a>))))
<a name="l00335"></a>00335         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Cannot initialize hooks.&quot;</span>);
<a name="l00336"></a>00336     <a class="code" href="kernel_8cc.html#a9847e8795839bc38fb1308084adcbfa8">KERNEL_PRINT_PROGRESS</a>;
<a name="l00337"></a>00337     
<a name="l00338"></a>00338     <span class="comment">// Shared heap will not be managed from the kernel, so do the next call from some master daemon:</span>
<a name="l00339"></a>00339     <span class="comment">// malloc_init([fake pointer],__sheap,SHARED_HEAP_SIZE);</span>
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <a class="code" href="kernel_8cc.html#a0630a11dd00b48b8d2b1d2a4a1dfa9de">KERNEL_PRINT_PROGRESS_END</a>;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="comment">// Basic memory management is up and running, so it is safe to use printf now.</span>
<a name="l00344"></a>00344     <a class="code" href="kernel_8cc.html#a77b4d1550e6990d959376de008f509ed">TDEBUG</a>(<span class="stringliteral">&quot;Booting kernel on processor %d...&quot;</span>,<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>());
<a name="l00345"></a>00345     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;boot param      : %p&quot;</span>,param);
<a name="l00346"></a>00346     <span class="keywordflow">if</span>(param&amp;&amp;param-&gt;<a class="code" href="structkernel__boot__param__t.html#a02eabea0f112079840971f63387ba3ef" title="pointer to a mailbox to signal a successful boot">notify_booted</a>)
<a name="l00347"></a>00347         <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;boot notify     : %p&quot;</span>,param-&gt;<a class="code" href="structkernel__boot__param__t.html#a02eabea0f112079840971f63387ba3ef" title="pointer to a mailbox to signal a successful boot">notify_booted</a>);
<a name="l00348"></a>00348     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;kernel_context  : %p&quot;</span>,<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <a class="code" href="kernel_8h.html#a05299296d8d9b39b4fff86d127f226de" title="equals &amp;kernel_context-&gt;stack[KERNEL_STACK_SIZE]">kernel_stack</a>=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#a7432dbb19710be479c632c77afc1da66" title="stack of the kernel">stack</a>[<a class="code" href="helix__config_8h.html#a77383d4c5311d4c7fe49364766887650" title="Size of kernel stack in words.">KERNEL_STACK_SIZE</a>];
<a name="l00351"></a>00351     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;kernel_stack    : %p&quot;</span>,<a class="code" href="kernel_8h.html#a05299296d8d9b39b4fff86d127f226de" title="equals &amp;kernel_context-&gt;stack[KERNEL_STACK_SIZE]">kernel_stack</a>);
<a name="l00352"></a>00352     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;reset vector    : 0x%08x 0x%08x&quot;</span>,*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x0),*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x4));
<a name="l00353"></a>00353     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;exception vector: 0x%08x 0x%08x&quot;</span>,*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x8),*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0xC));
<a name="l00354"></a>00354     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;interrupt vector: 0x%08x 0x%08x&quot;</span>,*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x10),*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x14));
<a name="l00355"></a>00355     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;hardware vector : 0x%08x 0x%08x&quot;</span>,*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x20),*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)0x24));
<a name="l00356"></a>00356     
<a name="l00357"></a>00357     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;caches          : I=0x%08x D=0x%08x&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="device_8h.html#a67f1f67e3ff3283ca7e487c6aa3489af" title="Returns the size of the instruction cache of this processor.">GetICacheSize</a>(),(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="device_8h.html#a104a9ba7c2ecfa8d246e29a4a4f711da" title="Returns the size of the data cache of this processor.">GetDCacheSize</a>());
<a name="l00358"></a>00358     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;memories        : L=0x%08x F=0x%08x&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="device_8h.html#a9a3bbe67a3a5b97327af7305f27c4d85" title="Returns the size of the local memory in bytes.">GetLocalMemSize</a>(),(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="device_8h.html#a055cc88594a49f5142b9c870c16b45d9" title="Returns the size of the FIFO memory in bytes.">GetFifoMemSize</a>());
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>()==0){
<a name="l00362"></a>00362         <a class="code" href="malloc_8h.html#a32fa1e9fd9ac5a6d4be0f2441c409550">malloc_dump</a>((<a class="code" href="structHTAG.html">HEAP</a>*)<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#abd271731ba5c4910eecc3eae6992ed0f" title="heap for this processor">heap</a>);
<a name="l00363"></a>00363         <a class="code" href="malloc_8h.html#a32fa1e9fd9ac5a6d4be0f2441c409550">malloc_dump</a>(<a class="code" href="kernel_8h.html#ab8a0d73d46ebb6fa412e87ac205bfc03" title="Pointer to the local FIFO memory HEAP structure.">_fifomem</a>);
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 <span class="preprocessor">#endif</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>
<a name="l00367"></a>00367     <span class="comment">// Initialize hardware</span>
<a name="l00368"></a>00368     <a class="code" href="io_8h.html#afd651f2742e136be8904e12b44d59b20" title="Stops the local timer.">kStopTimer</a>();
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment">// Set current context to an unused context.</span>
<a name="l00371"></a>00371     <span class="comment">// When the first interrupt arrives to start scheduling, the current context must be stored somewhere.</span>
<a name="l00372"></a>00372     <span class="comment">// However, the current context will be thrown away, so dump to an unused proc_context</span>
<a name="l00373"></a>00373 <span class="preprocessor">#if MAX_PROCESSES&lt;2</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">#error &quot;Not enough processes supported by the kernel, need at least 2.&quot;</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>    <a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>* dummy_context=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>-1].<a class="code" href="struct__proc__table__t.html#aaa93be5012a07072558257063612c6b5" title="processor context of this process">context</a>;
<a name="l00377"></a>00377     <span class="comment">// Make sure that the context is written, otherwise the stack overflow detection might kick in.</span>
<a name="l00378"></a>00378     dummy_context-&gt;<a class="code" href="structproc__context__t.html#ad40ec6ee16b202bea35212aa7d5b2db9" title="the context will not be written back during a context switch when donttouch != 0">donttouch</a>=0;
<a name="l00379"></a>00379     <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>,dummy_context);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="comment">// Initialize all process information</span>
<a name="l00382"></a>00382     <span class="keywordflow">for</span>(pid_t i=0;i&lt;<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>;i++){
<a name="l00383"></a>00383         <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i].<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>;
<a name="l00384"></a>00384         <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i].<a class="code" href="struct__proc__table__t.html#a2a1920067f74dd25917973ce22da4540" title="process ID of this process">pid</a>=i;
<a name="l00385"></a>00385         <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i].<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i];
<a name="l00386"></a>00386         <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i].<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i];
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388     
<a name="l00389"></a>00389 <span class="preprocessor">#ifdef SCC_REQUIRE_WRITETHROUGH</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a11624488cf36fd92f24933fdadd2001a" title="Returns configuration settings of this core.">GetMBFlags</a>()&amp;<a class="code" href="device_8h.html#a5f0d6688caae66b81465076bfe7f7f65">MB_FLAG_DCACHE_WRITEBACK</a>)
<a name="l00391"></a>00391         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Current software cache coherency without distributed locks only works with write-through cache.&quot;</span>);
<a name="l00392"></a>00392 <span class="preprocessor">#endif</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span><span class="preprocessor">#ifndef ALL_MEM_CACHED</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a11624488cf36fd92f24933fdadd2001a" title="Returns configuration settings of this core.">GetMBFlags</a>()&amp;<a class="code" href="device_8h.html#a754ce866d0283179105c8b9fe458e32e">MB_FLAG_SHARED_HEAP_CACHED</a>)
<a name="l00395"></a>00395         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Hardware caches all memory, but kernel is not compiled for that.&quot;</span>);
<a name="l00396"></a>00396 <span class="preprocessor">#endif</span>
<a name="l00397"></a>00397 <span class="preprocessor"></span><span class="preprocessor">#ifdef USE_DISTRIBUTED_LOCK</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a93e7f372ca638643179112c5975e02c1" title="Returns the number of cores in the SoC.">GetSoCCores</a>()!=NUM_PROCESSORS){
<a name="l00399"></a>00399         <a class="code" href="kernel_8cc.html#aa814952312a46824ecd43f85b6d45157">DEBUG</a>(<span class="stringliteral">&quot;The kernel is compiled for %d processors, but %d physical cores are found.&quot;</span>,NUM_PROCESSORS,<a class="code" href="device_8h.html#a93e7f372ca638643179112c5975e02c1" title="Returns the number of cores in the SoC.">GetSoCCores</a>());
<a name="l00400"></a>00400         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Distributed lock requires that the number of physical cores corresponds to NUM_PROCESSORS.&quot;</span>);
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402 <span class="preprocessor">#endif</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span>
<a name="l00404"></a>00404     <span class="comment">// Initialize pthread specific stuff</span>
<a name="l00405"></a>00405     <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(param-&gt;<a class="code" href="structkernel__boot__param__t.html#a02eabea0f112079840971f63387ba3ef" title="pointer to a mailbox to signal a successful boot">notify_booted</a>!=NULL||<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>()==0,<span class="stringliteral">&quot;Usually, core 0 is the master core... We are now %d.&quot;</span>,<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>());
<a name="l00406"></a>00406     <span class="keywordtype">int</span> res;
<a name="l00407"></a>00407     <span class="comment">// when notify_booted==NULL, this must be the master core</span>
<a name="l00408"></a>00408     <span class="keywordflow">if</span>(!param-&gt;<a class="code" href="structkernel__boot__param__t.html#a02eabea0f112079840971f63387ba3ef" title="pointer to a mailbox to signal a successful boot">notify_booted</a>){
<a name="l00409"></a>00409         <span class="keywordflow">if</span>((res=<a class="code" href="pthread_8h.html#a1b51e0b47abb96054c9305ecf30385b9">pthread_global_init</a>())!=0){
<a name="l00410"></a>00410             <a class="code" href="kernel_8cc.html#aa814952312a46824ecd43f85b6d45157">DEBUG</a>(<span class="stringliteral">&quot;pthread global initialization failed: %d&quot;</span>,res);
<a name="l00411"></a>00411             <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;pthread global initialization failed&quot;</span>);
<a name="l00412"></a>00412         }
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414     <span class="keywordflow">if</span>((res=<a class="code" href="pthread_8h.html#a9b6fd7a660bedd5b58309f6a679e4ddb">pthread_local_init</a>())!=0){
<a name="l00415"></a>00415         <a class="code" href="kernel_8cc.html#aa814952312a46824ecd43f85b6d45157">DEBUG</a>(<span class="stringliteral">&quot;pthread local initialization failed: %d&quot;</span>,res);
<a name="l00416"></a>00416         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;pthread local initialization failed&quot;</span>);
<a name="l00417"></a>00417     }<span class="keywordflow">else</span>
<a name="l00418"></a>00418         sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>=(<a class="code" href="structpthread__sch__t.html">pthread_sch_t</a>*)<a class="code" href="kernel_8h.html#a406d0bdfe086c5eb4cf028f6a560b5b1" title="Returns the pointer to the hook table.">kGetHookTable</a>()[<a class="code" href="hooks_8h.html#a7f8c368a9e590590126807cf07598a09" title="The hook is an address to the pthread_sch_t structure with per-process scheduling information...">HOOK_SCHEDULER</a>];
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <a class="code" href="kernel_8cc.html#a017d3e8af0a7f0e5266f61ac26fadd66">kSetOSState</a>(<a class="code" href="kernel_8h.html#a377ea6c9edb9a0cb4c553bd158580fbea1b1f033db08d1cefb74e04aeaeaac9a4">OS_SINGLE</a>);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="comment">// Initialize tracing</span>
<a name="l00423"></a>00423     <a class="code" href="structtrace__t.html">trace_t</a>* t <a class="code" href="info__app_8h.html#aeab68f17dc686a2f7dc72ab2b712e464">__attribute__</a>((unused))=<a class="code" href="trace_8h.html#af2ea43636e1626d9243ec946bd356667" title="Initializes the trace data structure.">kTraceInit</a>();
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>    <span class="keyword">struct </span>timeval tv;
<a name="l00427"></a>00427     <a class="code" href="newlibstubs_8cc.html#aaf2d0a99430a6d5253b8c395c30ca7e3" title="newlib syscall: returns the current time.">gettimeofday</a>(&amp;tv,NULL);
<a name="l00428"></a>00428     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;Kernel is up and running since %u.%03u s after reset.&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tv.tv_sec,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(tv.tv_usec/1000));
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>()==0){
<a name="l00431"></a>00431         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00432"></a>00432         <a class="code" href="api_8h.html#a9486aed655c4b43e0605e4f488f58819">DumpConfig</a>();
<a name="l00433"></a>00433         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 <span class="preprocessor">#endif</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>}
<a name="l00437"></a>00437 <span class="comment"></span>
<a name="l00438"></a>00438 <span class="comment">/*!</span>
<a name="l00439"></a>00439 <span class="comment"> * \brief Starts the task daemon</span>
<a name="l00440"></a>00440 <span class="comment"> *</span>
<a name="l00441"></a>00441 <span class="comment"> * This is essentially a wrapper around kCreateProcess() and kStartProcess().</span>
<a name="l00442"></a>00442 <span class="comment"> * It will call InitTaskDaemon(), which should be implemented by the application.</span>
<a name="l00443"></a>00443 <span class="comment"> *</span>
<a name="l00444"></a>00444 <span class="comment"> * \param param as received by main(int,char**)</span>
<a name="l00445"></a>00445 <span class="comment"> */</span>
<a name="l00446"></a><a class="code" href="kernel_8cc.html#ac684d34fd7c17e04891439d2d179c78e">00446</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#ac684d34fd7c17e04891439d2d179c78e" title="Starts the task daemon.">kStartTaskDaemon</a>(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* param){
<a name="l00447"></a>00447     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;Starting task daemon...&quot;</span>);
<a name="l00448"></a>00448     <span class="comment">// copy param (which is a local variable) to the heap;</span>
<a name="l00449"></a>00449     <span class="comment">// the local variable will be destroyed when the scheduler kicks in</span>
<a name="l00450"></a>00450     <a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>* p=(<a class="code" href="structkernel__boot__param__t.html" title="The optional parameter to main(int,char**) when the kernel boots.">kernel_boot_param_t</a>*)<a class="code" href="malloc_8cc.html#a7ac38fce3243a7dcf448301ee9ffd392">malloc</a>(<span class="keyword">sizeof</span>(*param));
<a name="l00451"></a>00451     <span class="keywordflow">if</span>(!p)
<a name="l00452"></a>00452         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Cannot save boot parameters&quot;</span>);
<a name="l00453"></a>00453     *p=*param;
<a name="l00454"></a>00454     pid_t <a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>=0;
<a name="l00455"></a>00455     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a71c6699c46b8ad0a1de3766cdf988ffe" title="Creates a new process.">kCreateProcess</a>(pid,&amp;<a class="code" href="group__daemons.html#ga34c09be46a7e6c258ddc19a38b424d8d" title="Initializes the task daemon.">InitTaskDaemon</a>,(<span class="keywordtype">void</span>*)p,<a class="code" href="daemons_8h.html#a961a71fd09d4765ede0ce6824476912d">TASK_DAEMON_TIMESLICE</a>,<a class="code" href="daemons_8h.html#ac9f21e22101eb5259a2c162093479c79">TASK_DAEMON_STACK</a>))
<a name="l00456"></a>00456         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Cannot create TaskDaemon&quot;</span>);
<a name="l00457"></a>00457 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(pid!=0)
<a name="l00459"></a>00459         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;TaskDaemon got strange pid!&quot;</span>);
<a name="l00460"></a>00460 <span class="preprocessor">#endif</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a042fff78c292d858b075822a528edaf9" title="Starts a process that has been created using kCreateProcess().">kStartProcess</a>(pid);
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 <span class="comment"></span>
<a name="l00464"></a>00464 <span class="comment">/*!</span>
<a name="l00465"></a>00465 <span class="comment"> * \brief Prints coredump and halts kernel, in case of emergency.</span>
<a name="l00466"></a>00466 <span class="comment"> * \param msg message to be printed, which indicates the reason of the core dump. Can be NULL.</span>
<a name="l00467"></a>00467 <span class="comment"> */</span>
<a name="l00468"></a><a class="code" href="kernel_8cc.html#a721cb139f6072c92a9d3b678b2f00184">00468</a> <span class="keywordtype">void</span> <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg){
<a name="l00469"></a>00469     <a class="code" href="kernel_8h.html#a6957c5970a115b6423dd285e22b96aa0">kDisableInterrupt</a>();
<a name="l00470"></a>00470     <a class="code" href="io_8h.html#afd651f2742e136be8904e12b44d59b20" title="Stops the local timer.">kStopTimer</a>();
<a name="l00471"></a>00471     <a class="code" href="kernel_8cc.html#aafee7403c191c45dd3a07b64954f828a">DEBUG_ON</a>(<a class="code" href="kernel_8cc.html#a38a287b0851d123e1e31072fcd03008d">DBLED_PANIC</a>);
<a name="l00472"></a>00472     <span class="keywordflow">for</span>(<span class="keyword">volatile</span> <span class="keywordtype">int</span> i=0;i&lt;1000000;i++);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="comment">// It is possible that the heap is not initialized when kPanic is called.</span>
<a name="l00475"></a>00475     <span class="comment">// In that case, printf cannot be used. So, use _puts here to make sure that the</span>
<a name="l00476"></a>00476     <span class="comment">// reason of the panic is printed properly.</span>
<a name="l00477"></a>00477     <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;\n\n *** Kernel PANIC! *** \n * Reason: &quot;</span>);
<a name="l00478"></a>00478     <span class="keywordflow">if</span>(msg){
<a name="l00479"></a>00479         <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(msg);
<a name="l00480"></a>00480         <a class="code" href="io_8h.html#a6d40e85c30e2f9b8cc4ea6b0f677bd22" title="Writes given string to the terminal.">_puts</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>    <span class="keyword">struct </span>timeval tv;
<a name="l00485"></a>00485     <a class="code" href="newlibstubs_8cc.html#aaf2d0a99430a6d5253b8c395c30ca7e3" title="newlib syscall: returns the current time.">gettimeofday</a>(&amp;tv,NULL);
<a name="l00486"></a>00486     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot; * Current time: %u.%03u s after reset.\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tv.tv_sec,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(tv.tv_usec/1000));
<a name="l00487"></a>00487 <span class="preprocessor">#endif</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a468106d328ee635cdc50e1fad751b655" title="Prints complete state of the current process and the kernel.">kCoreDump</a>();
<a name="l00489"></a>00489     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot; * Dumping heaps\n&quot;</span>);
<a name="l00490"></a>00490     <a class="code" href="malloc_8h.html#a32fa1e9fd9ac5a6d4be0f2441c409550">malloc_dump</a>((<a class="code" href="structHTAG.html">HEAP</a>*)<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#abd271731ba5c4910eecc3eae6992ed0f" title="heap for this processor">heap</a>);
<a name="l00491"></a>00491     <a class="code" href="malloc_8h.html#a32fa1e9fd9ac5a6d4be0f2441c409550">malloc_dump</a>(<a class="code" href="kernel_8h.html#ab8a0d73d46ebb6fa412e87ac205bfc03" title="Pointer to the local FIFO memory HEAP structure.">_fifomem</a>);
<a name="l00492"></a>00492     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot; *** End of core dump, halt processor %d ***\n&quot;</span>,<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>());
<a name="l00493"></a>00493     <a class="code" href="kernel_8cc.html#a017d3e8af0a7f0e5266f61ac26fadd66">kSetOSState</a>(<a class="code" href="kernel_8h.html#a377ea6c9edb9a0cb4c553bd158580fbea0753d1a5e1542769dbede19d9514edca">OS_BOOT</a>);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="comment">// Flush DCache to allow stack trace etc. from XMD</span>
<a name="l00496"></a>00496     <a class="code" href="device_8h.html#a561b9d014956c94fc705826f9d78710f" title="Flushes (means: write back and invalidate) the complete data cache.">FlushDCache</a>();
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <a class="code" href="device_8h.html#a4686cd354d0395599259d7c512391cad" title="Disables data cache (when available).">DisableDCache</a>();
<a name="l00499"></a>00499     <a class="code" href="device_8h.html#a9f82096fc6ab61162aef822a86c9a7b6" title="Disables instruction cache (when available).">DisableICache</a>();
<a name="l00500"></a>00500     <a class="code" href="kernel_8h.html#a07f2e6566f212b6272752685f3579ff4">kReset</a>();
<a name="l00501"></a>00501     <span class="keywordflow">while</span>(<span class="keyword">true</span>);
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 <span class="comment"></span>
<a name="l00504"></a>00504 <span class="comment">/*!</span>
<a name="l00505"></a>00505 <span class="comment"> * \brief Shuts down kernel and return to bootloader.</span>
<a name="l00506"></a>00506 <span class="comment"> * \details Not gracefull, no process termination, just reboot immediately.</span>
<a name="l00507"></a>00507 <span class="comment"> * \returns EPERM when another process than the task daemon tries to shutdown, otherwise never</span>
<a name="l00508"></a>00508 <span class="comment"> */</span>
<a name="l00509"></a><a class="code" href="kernel_8cc.html#a6b46db337054df057344ae05e29b43db">00509</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#af80c0747d727908fe6a8cacf9cc4be09" title="Shuts down kernel and return to bootloader.">kShutdown</a>(){
<a name="l00510"></a>00510     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()!=0)
<a name="l00511"></a>00511         <span class="keywordflow">return</span> EPERM;
<a name="l00512"></a>00512     
<a name="l00513"></a>00513     <span class="comment">// wait for our time slot to print to console</span>
<a name="l00514"></a>00514     <a class="code" href="kernel_8cc.html#a77b4d1550e6990d959376de008f509ed">TDEBUG</a>(<span class="stringliteral">&quot;Shutdown&quot;</span>);
<a name="l00515"></a>00515     
<a name="l00516"></a>00516     <a class="code" href="kernel_8h.html#a6957c5970a115b6423dd285e22b96aa0">kDisableInterrupt</a>();
<a name="l00517"></a>00517     <a class="code" href="device_8h.html#a4686cd354d0395599259d7c512391cad" title="Disables data cache (when available).">DisableDCache</a>();
<a name="l00518"></a>00518     <a class="code" href="device_8h.html#a9f82096fc6ab61162aef822a86c9a7b6" title="Disables instruction cache (when available).">DisableICache</a>();
<a name="l00519"></a>00519     <a class="code" href="kernel_8h.html#a07f2e6566f212b6272752685f3579ff4">kReset</a>();
<a name="l00520"></a>00520     <span class="keywordflow">while</span>(<span class="keyword">true</span>);
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 <span class="comment"></span>
<a name="l00523"></a>00523 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00524"></a>00524 <span class="comment"></span><span class="comment">// Process lifetime</span><span class="comment"></span>
<a name="l00525"></a>00525 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l00526"></a>00526 <span class="comment"></span><span class="comment"></span>
<a name="l00527"></a>00527 <span class="comment">/*!</span>
<a name="l00528"></a>00528 <span class="comment"> * \brief Returns the process id of the current process</span>
<a name="l00529"></a>00529 <span class="comment"> */</span>
<a name="l00530"></a><a class="code" href="kernel_8cc.html#ac15d916c2ab5a6adfa64f13f43050266">00530</a> pid_t <a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>(){
<a name="l00531"></a>00531     <span class="keywordflow">return</span> <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a2a1920067f74dd25917973ce22da4540" title="process ID of this process">pid</a>;
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 <span class="comment"></span>
<a name="l00534"></a>00534 <span class="comment">/*!</span>
<a name="l00535"></a>00535 <span class="comment"> * \brief Creates a new process.</span>
<a name="l00536"></a>00536 <span class="comment"> * \details By default, a process is created detached.</span>
<a name="l00537"></a>00537 <span class="comment"> * \details Only the task daemon is allowed to start new processes.</span>
<a name="l00538"></a>00538 <span class="comment"> * \param pid the new process id will be written to the pointer supplied</span>
<a name="l00539"></a>00539 <span class="comment"> * \param main the main function of this process</span>
<a name="l00540"></a>00540 <span class="comment"> * \param arg an optional argument to main, can be NULL</span>
<a name="l00541"></a>00541 <span class="comment"> * \param slicelength the length of the allocated time slice in ms</span>
<a name="l00542"></a>00542 <span class="comment"> * \param stack the size of the stack in words</span>
<a name="l00543"></a>00543 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00544"></a>00544 <span class="comment"> */</span>
<a name="l00545"></a><a class="code" href="kernel_8cc.html#ab02050bfd20dee07ad5c48dc98018540">00545</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a71c6699c46b8ad0a1de3766cdf988ffe" title="Creates a new process.">kCreateProcess</a>(pid_t &amp;<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>,<span class="keywordtype">void</span>* (*<a class="code" href="trace_8cc.html#a6d69200d49b04a26bc8a6c30ba0bff0c">main</a>)(<span class="keywordtype">void</span>*),<span class="keywordtype">void</span>* arg,<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a> slicelength,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stack){
<a name="l00546"></a>00546     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=NULL;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="comment">// only the TaskDaemon is allowed to start processes</span>
<a name="l00549"></a>00549     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()!=0)
<a name="l00550"></a>00550         <span class="keywordflow">return</span> EPERM;
<a name="l00551"></a>00551     <span class="keywordflow">if</span>(slicelength==0)
<a name="l00552"></a>00552         <span class="keywordflow">return</span> EINVAL;
<a name="l00553"></a>00553     <span class="comment">// find free PID</span>
<a name="l00554"></a>00554     <span class="keywordflow">for</span>(pid=0;pid&lt;<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a> &amp;&amp; (pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>])-&gt;state!=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>;pid++);
<a name="l00555"></a>00555     <span class="comment">// no free PIDs</span>
<a name="l00556"></a>00556     <span class="keywordflow">if</span>(pid==<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00557"></a>00557         <span class="keywordflow">return</span> EAGAIN;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     <a class="code" href="kernel_8cc.html#aafee7403c191c45dd3a07b64954f828a">DEBUG_ON</a>(<a class="code" href="kernel_8cc.html#a669e9dd46ec1bdacc6cd2fbd9b530a70">DBLED_NEWPROC</a>);
<a name="l00560"></a>00560 <span class="comment">//  DEBUG(&quot;Creating process: pid %d, main %p, arg %p, time %d, stack 0x%x&quot;,pid,main,arg,slicelength,(unsigned int)stack);</span>
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span>    <span class="comment">// stack overflow detection field</span>
<a name="l00564"></a>00564     stack+=<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int);
<a name="l00565"></a>00565 <span class="preprocessor">#endif</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(!(pt-&gt;stack=(<span class="keywordtype">char</span>*)<a class="code" href="malloc_8h.html#a3a3184ad758e4df40ba9a1f2196e88d9">omalloc</a>(stack,pid)))
<a name="l00567"></a>00567         <span class="keywordflow">return</span> ENOMEM;
<a name="l00568"></a>00568 <span class="preprocessor">#ifdef TRAP_ALL_DMEM_ACCESS</span>
<a name="l00569"></a>00569 <span class="preprocessor"></span>    pt-&gt;stack_size=stack;
<a name="l00570"></a>00570 <span class="preprocessor">#endif</span>
<a name="l00571"></a>00571 <span class="preprocessor"></span><span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00572"></a>00572 <span class="preprocessor"></span>    *(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)pt-&gt;stack=<a class="code" href="kernel_8cc.html#adb8d91529f94de9573a88c3b8514ac6f">STACK_PROTECTION_VALUE</a>;
<a name="l00573"></a>00573 #endif
<a name="l00574"></a>00574 #ifdef <a class="code" href="helix__config_8h.html#abeff2b775ff66dbc9e1c9a1695219cd1" title="Enable to add stack usage measurements (which is expensive and does not detect overflows).">MEASURE_STACK_USAGE</a>
<a name="l00575"></a>00575     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s=0;s&lt;stack/<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>);s++)
<a name="l00576"></a>00576         ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)pt-&gt;stack)[s]=<a class="code" href="kernel_8cc.html#adb8d91529f94de9573a88c3b8514ac6f">STACK_PROTECTION_VALUE</a>;
<a name="l00577"></a>00577 <span class="preprocessor">#endif</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span>
<a name="l00579"></a>00579     <span class="keywordflow">if</span>(!(pt-&gt;impure_data=(<span class="keyword">struct</span> _reent *__ATTRIBUTE_IMPURE_PTR__)<a class="code" href="malloc_8h.html#a3a3184ad758e4df40ba9a1f2196e88d9">omalloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> _reent __ATTRIBUTE_IMPURE_PTR__),pid)))
<a name="l00580"></a>00580         <span class="keywordflow">return</span> ENOMEM;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     _REENT_INIT_PTR(pt-&gt;impure_data);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">if</span>(!(pt-&gt;proc_local=(<a class="code" href="structproc__local__t.html">proc_local_t</a>*)<a class="code" href="malloc_8h.html#a3a3184ad758e4df40ba9a1f2196e88d9">omalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structproc__local__t.html">proc_local_t</a>),pid)))
<a name="l00585"></a>00585         <span class="keywordflow">return</span> ENOMEM;
<a name="l00586"></a>00586     memset(pt-&gt;proc_local,0,<span class="keyword">sizeof</span>(<a class="code" href="structproc__local__t.html">proc_local_t</a>));
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <a class="code" href="kernel_8h.html#a4f2533d3d9b2c62657a9d722a6c4a329" title="Initializes a context of a newly created process.">kInitContext</a>(&amp;pt-&gt;context,<a class="code" href="trace_8cc.html#a6d69200d49b04a26bc8a6c30ba0bff0c">main</a>,arg,pt-&gt;stack+stack);
<a name="l00589"></a>00589     pt-&gt;state=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aec34b0b90541576a22697631105dc847" title="process has been created, but not started">NEW</a>;
<a name="l00590"></a>00590     pt-&gt;main=<a class="code" href="trace_8cc.html#a6d69200d49b04a26bc8a6c30ba0bff0c">main</a>;
<a name="l00591"></a>00591     pt-&gt;channels=NULL;
<a name="l00592"></a>00592     pt-&gt;num_channels=0;
<a name="l00593"></a>00593     pt-&gt;flags=<a class="code" href="kernel__types_8h.html#ae551326f70d87799d5eff1e057af7a40" title="indicates that the process will be ZOMBIE when it ends">PROC_FLAG_DETACHED</a>;
<a name="l00594"></a>00594     pt-&gt;next_entry=pt;
<a name="l00595"></a>00595     pt-&gt;prev_entry=pt;
<a name="l00596"></a>00596 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>    <a class="code" href="kernel_8cc.html#a5eda2256972d4e67ab045cb3ebfa4ecf">kInitSignalContext</a>(&amp;pt-&gt;sig_context,&amp;pt-&gt;context,&amp;pt-&gt;sig_triggered[0],&amp;pt-&gt;sig_havetriggered);
<a name="l00598"></a>00598     <a class="code" href="signal_8h.html#afa153544785c72243ba8c620bf23206a">InitSignalList</a>(&amp;pt-&gt;sig_action[0]);
<a name="l00599"></a>00599     <a class="code" href="signal_8h.html#a8ea8c8a7abbe0465d34702dfc418b4bb">sigfillset</a>(&amp;pt-&gt;sig_enabled);
<a name="l00600"></a>00600     <a class="code" href="signal_8h.html#ae79ee4f6407e141d2fd85f68f04c309f">sigemptyset</a>((<a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a>*)&amp;pt-&gt;sig_mask);
<a name="l00601"></a>00601     memset(&amp;pt-&gt;sig_triggered,0,<span class="keyword">sizeof</span>(pt-&gt;sig_triggered));
<a name="l00602"></a>00602     pt-&gt;sig_havetriggered=0;
<a name="l00603"></a>00603     <a class="code" href="signal_8h.html#ae79ee4f6407e141d2fd85f68f04c309f">sigemptyset</a>((<a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a>*)&amp;pt-&gt;sig_sticky);
<a name="l00604"></a>00604     pt-&gt;sig_ret=0;
<a name="l00605"></a>00605     pt-&gt;time_yielded=0;
<a name="l00606"></a>00606 <span class="preprocessor">#endif</span>
<a name="l00607"></a>00607 <span class="preprocessor"></span><span class="preprocessor">#ifdef KERNEL_SYNC_EVENTS</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span>    memset(&amp;pt-&gt;sync_event[0],0,<span class="keyword">sizeof</span>(pt-&gt;sync_event));
<a name="l00609"></a>00609 <span class="preprocessor">#endif</span>
<a name="l00610"></a>00610 <span class="preprocessor"></span><span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l00611"></a>00611 <span class="preprocessor"></span>    pt-&gt;slack=0;
<a name="l00612"></a>00612     pt-&gt;time_alloc=0;
<a name="l00613"></a>00613     pt-&gt;min_stack=(int)stack;
<a name="l00614"></a>00614     pt-&gt;context_switches=0;
<a name="l00615"></a>00615     pt-&gt;yields=0;
<a name="l00616"></a>00616 <span class="preprocessor">#endif</span>
<a name="l00617"></a>00617 <span class="preprocessor"></span>    <span class="keywordtype">int</span> res;
<a name="l00618"></a>00618     <span class="keywordflow">if</span>((res=<a class="code" href="kernel_8h.html#a61d8f69187fd2e5f7521bd2285e834bc" title="Changes the length of the timeslice of an existing process.">kSetProcessTimeslice</a>(pid,slicelength))){
<a name="l00619"></a>00619         <a class="code" href="kernel_8h.html#a847a95e0b86135a016db40def9286aa4" title="Destroys and clean up a process.">kDestroyProcess</a>(pid,NULL);
<a name="l00620"></a>00620         <span class="keywordflow">return</span> res;
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622     
<a name="l00623"></a>00623     <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>)
<a name="l00624"></a>00624         <a class="code" href="mc_8h.html#a031261eaad96e3eaafac6c1c9ba923ac">mc_apply</a>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#a916f62e6eaafb138c53e469e3959ac60">processes</a>,++);
<a name="l00625"></a>00625     
<a name="l00626"></a>00626 <span class="comment">//  DEBUG(&quot;proc table at %p, context at %p, stack at %p, thread_local at %p, impure data at %p&quot;,pt,&amp;pt-&gt;context,pt-&gt;stack,pt-&gt;proc_local-&gt;user,pt-&gt;impure_data);</span>
<a name="l00627"></a>00627 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span><span class="comment">//  DEBUG(&quot;New process %d (context: %p/%p)&quot;,pid,&amp;pt-&gt;context,&amp;pt-&gt;sig_context);</span>
<a name="l00629"></a>00629 <span class="preprocessor">#else</span>
<a name="l00630"></a>00630 <span class="preprocessor"></span><span class="comment">//  DEBUG(&quot;New process %d (context: %p)&quot;,pid,&amp;pt-&gt;context);</span>
<a name="l00631"></a>00631 <span class="preprocessor">#endif</span>
<a name="l00632"></a>00632 <span class="preprocessor"></span>
<a name="l00633"></a>00633     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00634"></a>00634 }
<a name="l00635"></a>00635 <span class="comment"></span>
<a name="l00636"></a>00636 <span class="comment">/*!</span>
<a name="l00637"></a>00637 <span class="comment"> * \brief Entry point of a process.</span>
<a name="l00638"></a>00638 <span class="comment"> * \details Initializes some stuff and calls the entry point as specified using kCreateProcess().</span>
<a name="l00639"></a>00639 <span class="comment"> */</span>
<a name="l00640"></a><a class="code" href="kernel_8cc.html#ab96af073ecdd6f0a8f2bc25176901778">00640</a> <span class="keywordtype">void</span>* <a class="code" href="kernel_8h.html#ab09b936c993bfbea1cfae958d97db1ed" title="Entry point of a process.">ProcessEntry</a>(<span class="keywordtype">void</span>* (*<a class="code" href="trace_8cc.html#a6d69200d49b04a26bc8a6c30ba0bff0c">main</a>)(<span class="keywordtype">void</span>*),<span class="keywordtype">void</span>* arg){
<a name="l00641"></a>00641     <span class="keywordtype">int</span> res;
<a name="l00642"></a>00642     <span class="keywordflow">if</span>((res=<a class="code" href="pthread_8h.html#abfb4b8bde00dccab9f8767ffd3e8ea06">pthread_thread_init</a>())){
<a name="l00643"></a>00643         <a class="code" href="kernel_8cc.html#aa814952312a46824ecd43f85b6d45157">DEBUG</a>(<span class="stringliteral">&quot;pthread thread init failed: %d&quot;</span>,res);
<a name="l00644"></a>00644         <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)res;
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646     atexit((<span class="keywordtype">void</span> (*)(<span class="keywordtype">void</span>))<a class="code" href="pthread_8h.html#a8505634283675941d26ac2ba5378109c">pthread_thread_cleanup</a>);
<a name="l00647"></a>00647 <span class="preprocessor">#ifdef ENABLE_TRACING</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>    atexit(<a class="code" href="trace_8h.html#a103a4e40486d7573b156ea633165948d" title="Simple wrapper to call TracePhaseChange() at process termination.">TraceExitProc</a>);
<a name="l00649"></a>00649     <a class="code" href="trace_8h.html#ad756e1f74ba341b282173b8c96e02f0f" title="Signals a new phase in the application.">TracePhaseChange</a>(<a class="code" href="trace_8h.html#a1e59969c3708f14ba17a4653fe67327e">TRACE_PHASE_RUNNING</a>);
<a name="l00650"></a>00650 <span class="preprocessor">#endif</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span>    <span class="keywordflow">if</span>((res=atexit(<a class="code" href="ShutdownDaemon_8cc.html#aaa7a6756eba8d2b799cdb124e039c62c" title="Function to cleanup process stuff, called by abort() and exit() (via atexit() ).">do_gracefull_exit_funs</a>)))
<a name="l00652"></a>00652         <a class="code" href="kernel_8cc.html#aa814952312a46824ecd43f85b6d45157">DEBUG</a>(<span class="stringliteral">&quot;Cannot register atexit() of process %d: %d&quot;</span>,<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>(),res);
<a name="l00653"></a>00653     <span class="keywordflow">return</span> <a class="code" href="trace_8cc.html#a6d69200d49b04a26bc8a6c30ba0bff0c">main</a>(arg);
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 <span class="comment"></span>
<a name="l00656"></a>00656 <span class="comment">/*!</span>
<a name="l00657"></a>00657 <span class="comment"> * \brief Sets specific process flags.</span>
<a name="l00658"></a>00658 <span class="comment"> * \details It is not safe to set the flags and join/destroy the process concurrent.</span>
<a name="l00659"></a>00659 <span class="comment"> * \details So, do process management of a single process in a safe manner.</span>
<a name="l00660"></a>00660 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00661"></a>00661 <span class="comment"> */</span>
<a name="l00662"></a><a class="code" href="kernel_8cc.html#a300b853030c48858f0eced0d188612c8">00662</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#ab97975dac7ad6c19d4168b31df471dd1" title="Sets specific process flags.">kSetProcessFlags</a>(pid_t pid,<span class="keywordtype">int</span> flags){
<a name="l00663"></a>00663     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00664"></a>00664         <span class="keywordflow">return</span> ESRCH;
<a name="l00665"></a>00665     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l00666"></a>00666     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l00667"></a>00667         <span class="keywordflow">return</span> ESRCH;
<a name="l00668"></a>00668     pt-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>=flags;
<a name="l00669"></a>00669     
<a name="l00670"></a>00670     <span class="comment">// pthread_detach() is called after pthread_create().</span>
<a name="l00671"></a>00671     <span class="comment">// So, when the process terminates quickly, the process could be</span>
<a name="l00672"></a>00672     <span class="comment">// in JOINABLE state before it can be detached.</span>
<a name="l00673"></a>00673     <span class="comment">// Hence, set to ZOMBIE in case it was already JOINABLE.</span>
<a name="l00674"></a>00674     barrier();
<a name="l00675"></a>00675     <span class="keywordflow">if</span>(flags&amp;<a class="code" href="kernel__types_8h.html#ae551326f70d87799d5eff1e057af7a40" title="indicates that the process will be ZOMBIE when it ends">PROC_FLAG_DETACHED</a>&amp;&amp;pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a95e3221d7fa874623eb789940f39c932" title="process has ended, but waits until kJoinProcess() is called">JOINABLE</a>)
<a name="l00676"></a>00676         pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a5dfb36109b24f39d54d5c3f48f53def8" title="process has ended, but not cleaned up">ZOMBIE</a>;
<a name="l00677"></a>00677     
<a name="l00678"></a>00678     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 <span class="comment"></span>
<a name="l00681"></a>00681 <span class="comment">/*!</span>
<a name="l00682"></a>00682 <span class="comment"> * \brief Gets the process flags.</span>
<a name="l00683"></a>00683 <span class="comment"> * \param pid the process to retrieve the flags of</span>
<a name="l00684"></a>00684 <span class="comment"> * \param flags will receive the flags of the process, cannot be NULL</span>
<a name="l00685"></a>00685 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00686"></a>00686 <span class="comment"> */</span>
<a name="l00687"></a><a class="code" href="kernel_8cc.html#ae0c79c082c04ae29f52e53ea5a5d9c9c">00687</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a131cca2bceafc7f4f46dce7bac3eb51e" title="Gets the process flags.">kGetProcessFlags</a>(pid_t pid,<span class="keywordtype">int</span> *flags){
<a name="l00688"></a>00688     <span class="keywordflow">if</span>(!flags)
<a name="l00689"></a>00689         <span class="keywordflow">return</span> EINVAL;
<a name="l00690"></a>00690     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00691"></a>00691         <span class="keywordflow">return</span> ESRCH;
<a name="l00692"></a>00692     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l00693"></a>00693     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l00694"></a>00694         <span class="keywordflow">return</span> ESRCH;
<a name="l00695"></a>00695     *flags=pt-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>;
<a name="l00696"></a>00696     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 <span class="comment"></span>
<a name="l00699"></a>00699 <span class="comment">/*!</span>
<a name="l00700"></a>00700 <span class="comment"> * \brief Returns the state of a process.</span>
<a name="l00701"></a>00701 <span class="comment"> * \param pid the process to retrieve the state of, -1 means myself</span>
<a name="l00702"></a>00702 <span class="comment"> * \param state will receive the state of the process</span>
<a name="l00703"></a>00703 <span class="comment"> * \param sighandling will set to true when the process is currently handling signals</span>
<a name="l00704"></a>00704 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00705"></a>00705 <span class="comment"> */</span>
<a name="l00706"></a><a class="code" href="kernel_8cc.html#abcef60d3ef2cf168ced79ec4f9ed4782">00706</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a0327db757c513be3cb4e03fea75ede20" title="Returns the state of a process.">kGetProcessState</a>(pid_t pid,<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484" title="The states of a process.">proc_state_t</a> *state,<span class="keywordtype">bool</span> *sighandling){
<a name="l00707"></a>00707     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt;
<a name="l00708"></a>00708     <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(pid==-1)){
<a name="l00709"></a>00709         pid=<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>();
<a name="l00710"></a>00710         pt=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>;
<a name="l00711"></a>00711     }<span class="keywordflow">else</span>{
<a name="l00712"></a>00712         <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00713"></a>00713             <span class="keywordflow">return</span> ESRCH;
<a name="l00714"></a>00714         pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l00715"></a>00715         <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l00716"></a>00716             <span class="keywordflow">return</span> ESRCH;
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718     <span class="keywordflow">if</span>(state)
<a name="l00719"></a>00719         *state=pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>;
<a name="l00720"></a>00720     <span class="keywordflow">if</span>(sighandling)
<a name="l00721"></a>00721         *sighandling=<a class="code" href="kernel_8cc.html#a0d73b8a648a1501b4a09c11bfd9c819c">kIsInSigHandler</a>(pt);
<a name="l00722"></a>00722     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 <span class="comment"></span>
<a name="l00725"></a>00725 <span class="comment">/*!</span>
<a name="l00726"></a>00726 <span class="comment"> * \brief Changes the length of the timeslice of an existing process.</span>
<a name="l00727"></a>00727 <span class="comment"> * \details When pid is the current process, the new time is effective after the next context switch</span>
<a name="l00728"></a>00728 <span class="comment"> * \param pid the process to change the timeslice of, which must exist</span>
<a name="l00729"></a>00729 <span class="comment"> * \param slicelength the length of the allocated time slice in ms</span>
<a name="l00730"></a>00730 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00731"></a>00731 <span class="comment"> */</span>
<a name="l00732"></a><a class="code" href="kernel_8cc.html#a0c8b0ba864ea12f0559c61874036795f">00732</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a61d8f69187fd2e5f7521bd2285e834bc" title="Changes the length of the timeslice of an existing process.">kSetProcessTimeslice</a>(pid_t pid,<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a> slicelength){
<a name="l00733"></a>00733     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="keywordflow">if</span>(slicelength==0)
<a name="l00736"></a>00736         <span class="keywordflow">return</span> EINVAL;
<a name="l00737"></a>00737     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00738"></a>00738         <span class="keywordflow">return</span> ESRCH;
<a name="l00739"></a>00739     pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l00740"></a>00740     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l00741"></a>00741         <span class="keywordflow">return</span> EINVAL;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     <a class="code" href="kernel__types_8h.html#a77e49d03a1e611dab893961ac9886155" title="type of scheduler timer, used internally">timeslice_t</a> ticks_in_ms=<a class="code" href="device_8h.html#a849ce054a843c28398da5b40f0918e77" title="Returns the clock frequency of the current core in Hz.">GetClockFreq</a>()/1000;
<a name="l00744"></a>00744     <span class="keywordflow">if</span>(slicelength&gt;(<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a>)(((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)-1)/ticks_in_ms))
<a name="l00745"></a>00745         <span class="comment">// slicelength out of range for the timer</span>
<a name="l00746"></a>00746         <span class="keywordflow">return</span> EINVAL;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="comment">// time in clock cycles</span>
<a name="l00749"></a>00749     pt-&gt;<a class="code" href="struct__proc__table__t.html#aa96b0dad43ede9e43c248df892370e12" title="assigned time slot size">time</a>=(<a class="code" href="kernel__types_8h.html#a77e49d03a1e611dab893961ac9886155" title="type of scheduler timer, used internally">timeslice_t</a>)slicelength*ticks_in_ms;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     <span class="comment">// trace change in process</span>
<a name="l00752"></a>00752     <a class="code" href="trace_8h.html#ad8b20224245a6b119b546a378096b142" title="Signals a change in the process information.">kTraceProcChange</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>,pid,pt-&gt;<a class="code" href="struct__proc__table__t.html#aa96b0dad43ede9e43c248df892370e12" title="assigned time slot size">time</a>,(<span class="keywordtype">void</span>*)pt-&gt;<a class="code" href="struct__proc__table__t.html#a1bf966e47dedb9f9fe54269ea1ac884e" title="entry point of the process">main</a>);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 <span class="comment"></span>
<a name="l00757"></a>00757 <span class="comment">/*!</span>
<a name="l00758"></a>00758 <span class="comment"> * \brief Returns the remaining clock ticks before the end of the current timeslice.</span>
<a name="l00759"></a>00759 <span class="comment"> * \details When interrupted by the timer, race conditions can occur, which result in a reported timeslice that is too high.</span>
<a name="l00760"></a>00760 <span class="comment"> * \details Call from user space, does not need a syscall.</span>
<a name="l00761"></a>00761 <span class="comment"> * \return the number of remaining clock cycles.</span>
<a name="l00762"></a>00762 <span class="comment"> */</span>
<a name="l00763"></a><a class="code" href="kernel_8cc.html#ae741e6ffe8b7b61c49654c7410f7a868">00763</a> <a class="code" href="kernel__types_8h.html#a77e49d03a1e611dab893961ac9886155" title="type of scheduler timer, used internally">timeslice_t</a> <a class="code" href="kernel_8h.html#af0f5336774a2f48f0ecb86ffe2a98089" title="Returns the remaining clock ticks before the end of the current timeslice.">GetRemainingTimeslice</a>(){
<a name="l00764"></a>00764     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timer=<a class="code" href="io_8h.html#a3eecd618b5ebf145802ab44fbd52c620" title="Returns the current value of the timer.">kGetTimer</a>();
<a name="l00765"></a>00765     <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)timer==-1)timer=0;
<a name="l00766"></a>00766 <span class="preprocessor">#ifndef SCHEDULE_SLOTS</span>
<a name="l00767"></a>00767 <span class="preprocessor"></span>    <span class="keywordflow">return</span> timer;
<a name="l00768"></a>00768 <span class="preprocessor">#else</span>
<a name="l00769"></a>00769 <span class="preprocessor"></span>    <span class="keywordflow">return</span> timer+(sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>-1)*<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>+<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>;
<a name="l00770"></a>00770 #endif
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 <span class="comment"></span>
<a name="l00773"></a>00773 <span class="comment">/*!</span>
<a name="l00774"></a>00774 <span class="comment"> * \brief Starts a process that has been created using kCreateProcess().</span>
<a name="l00775"></a>00775 <span class="comment"> * \details Only the task daemon is allowed to start processes.</span>
<a name="l00776"></a>00776 <span class="comment"> * \param pid the process to start</span>
<a name="l00777"></a>00777 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00778"></a>00778 <span class="comment"> */</span>
<a name="l00779"></a><a class="code" href="kernel_8cc.html#a82ebacc8496cf56e9df915b1103222f5">00779</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a042fff78c292d858b075822a528edaf9" title="Starts a process that has been created using kCreateProcess().">kStartProcess</a>(pid_t pid){
<a name="l00780"></a>00780     <span class="comment">// only the TaskDaemon is allowed to start processes</span>
<a name="l00781"></a>00781     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()!=0)
<a name="l00782"></a>00782         <span class="keywordflow">return</span> EPERM;
<a name="l00783"></a>00783     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00784"></a>00784         <span class="keywordflow">return</span> ESRCH;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l00787"></a>00787     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>!=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aec34b0b90541576a22697631105dc847" title="process has been created, but not started">NEW</a>)
<a name="l00788"></a>00788         <span class="keywordflow">return</span> EINVAL;
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="comment">// enable process</span>
<a name="l00791"></a>00791     pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="comment">// update schedule</span>
<a name="l00794"></a>00794     pt-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>;
<a name="l00795"></a>00795     pt-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>;
<a name="l00796"></a>00796     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>!=<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>)
<a name="l00797"></a>00797         pt-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>=pt;
<a name="l00798"></a>00798     barrier();
<a name="l00799"></a>00799     <span class="comment">// the next line will put the process in the schedule sequence</span>
<a name="l00800"></a>00800     <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>=pt;
<a name="l00801"></a>00801     <span class="comment">// make sure a yield will have effect</span>
<a name="l00802"></a>00802     sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <a class="code" href="kernel_8cc.html#ad7b6b6cb649dc9d9560c68b1d94464f9">DEBUG_OFF</a>(<a class="code" href="kernel_8cc.html#a669e9dd46ec1bdacc6cd2fbd9b530a70">DBLED_NEWPROC</a>);
<a name="l00805"></a>00805     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 <span class="comment"></span>
<a name="l00808"></a>00808 <span class="comment">/*!</span>
<a name="l00809"></a>00809 <span class="comment"> * \brief Forcably ends the timeslice of the current process.</span>
<a name="l00810"></a>00810 <span class="comment"> * \todo fix, several race conditions exist!</span>
<a name="l00811"></a>00811 <span class="comment"> * \param havework set to false when no work has been done and none is expected soon; this prevents rapid rescheduling</span>
<a name="l00812"></a>00812 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l00813"></a>00813 <span class="comment"> */</span>
<a name="l00814"></a><a class="code" href="kernel_8cc.html#a505234ecb7b50794d55df4e59f5326df">00814</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#ab91f44b41a9180f07267ac1ead6dfdbd" title="Forcably ends the timeslice of the current process.">kYield</a>(<span class="keywordtype">bool</span> havework){
<a name="l00815"></a>00815     <span class="keywordflow">if</span>(havework)
<a name="l00816"></a>00816         sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l00817"></a>00817     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>==<a class="code" href="kernel_8cc.html#a2c73da0c8100fb61b4e9ed91ec30134d">DID_WORK_MAYBE</a>)
<a name="l00818"></a>00818         sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a6646eba88004157f0b0e52925526488d">DID_WORK_NO</a>;
<a name="l00819"></a>00819     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()==0){
<a name="l00820"></a>00820         <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">have_work</a>==<a class="code" href="kernel_8cc.html#a6646eba88004157f0b0e52925526488d">DID_WORK_NO</a>&amp;&amp;sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>&lt;=<a class="code" href="kernel_8cc.html#a2c73da0c8100fb61b4e9ed91ec30134d">DID_WORK_MAYBE</a>){
<a name="l00821"></a>00821             <span class="comment">// a yield will context switch to myself, so don&#39;t do that</span>
<a name="l00822"></a>00822             <span class="keywordflow">if</span>(!sch.<a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">was_idle</a>&amp;&amp;sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>){
<a name="l00823"></a>00823                 <a class="code" href="mc_8h.html#ab52e7f17556fb7799edfbc08e7e3ab38">mc_entry_wou</a>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#ad249de83e9289311f204c544f7abd40a">idle</a>);
<a name="l00824"></a>00824                 sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#ad249de83e9289311f204c544f7abd40a">idle</a>=sch.<a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">was_idle</a>=1;
<a name="l00825"></a>00825                 <a class="code" href="mc_8h.html#a521fcceaff33374628cd711eec53c25f">mc_exit_wou</a>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#ad249de83e9289311f204c544f7abd40a">idle</a>);
<a name="l00826"></a>00826             }
<a name="l00827"></a>00827             <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00828"></a>00828         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">was_idle</a>&amp;&amp;sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>){
<a name="l00829"></a>00829             <a class="code" href="mc_8h.html#ab52e7f17556fb7799edfbc08e7e3ab38">mc_entry_wou</a>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#ad249de83e9289311f204c544f7abd40a">idle</a>);
<a name="l00830"></a>00830             sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#ad249de83e9289311f204c544f7abd40a">idle</a>=sch.<a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">was_idle</a>=0;
<a name="l00831"></a>00831             <a class="code" href="mc_8h.html#a521fcceaff33374628cd711eec53c25f">mc_exit_wou</a>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#ad249de83e9289311f204c544f7abd40a">idle</a>);
<a name="l00832"></a>00832         }
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a4e465f239d5faa916030d74febb62511" title="number of Yield()s">yields</a>++;
<a name="l00837"></a>00837 <span class="preprocessor">#endif</span>
<a name="l00838"></a>00838 <span class="preprocessor"></span>
<a name="l00839"></a>00839     <span class="comment">// read rest of timeslice/slot</span>
<a name="l00840"></a>00840     <a class="code" href="kernel__types_8h.html#a77e49d03a1e611dab893961ac9886155" title="type of scheduler timer, used internally">timeslice_t</a> yielded=<a class="code" href="io_8h.html#a3eecd618b5ebf145802ab44fbd52c620" title="Returns the current value of the timer.">kGetTimer</a>();
<a name="l00841"></a>00841 <span class="preprocessor">#ifdef SCHEDULE_SLOTS</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span>    <span class="comment">// calculate actual yielded time</span>
<a name="l00843"></a>00843     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remaining_slots=sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>;
<a name="l00844"></a>00844     <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(remaining_slots&gt;0,<span class="stringliteral">&quot;Running beyond timeslice boundaries&quot;</span>);
<a name="l00845"></a>00845     yielded+=(remaining_slots-1)*<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>;
<a name="l00846"></a>00846 <span class="preprocessor">#endif</span>
<a name="l00847"></a>00847 <span class="preprocessor"></span><span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l00848"></a>00848 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ac9c6ed46b712dd9ad7f53f5c670dc895" title="slack time Yield()ed">slack</a>+=yielded;
<a name="l00849"></a>00849 <span class="preprocessor">#endif</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span><span class="preprocessor">#ifdef SCHEDULE_SLOTS</span>
<a name="l00851"></a>00851 <span class="preprocessor"></span>    yielded+=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>;
<a name="l00852"></a>00852 <span class="preprocessor">#endif</span>
<a name="l00853"></a>00853 <span class="preprocessor"></span>    
<a name="l00854"></a>00854     <span class="comment">// Trace this yield</span>
<a name="l00855"></a>00855     <a class="code" href="trace_8h.html#a88ebbec642cfc0c4c52d9cd43f4b8476">kTraceYield</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>,yielded);
<a name="l00856"></a>00856     
<a name="l00857"></a>00857     <span class="comment">// substract penalty of doing context switches</span>
<a name="l00858"></a>00858     <span class="keywordflow">if</span>(yielded&lt;<a class="code" href="helix__config_8h.html#a15325bbf6b4381e66b02c77520b8a0dd" title="The number of cycles a context switch costs, used to calculated spare time after Yield().">CONTEXT_SWITCH_CYCLE_PANELTY</a>*2)
<a name="l00859"></a>00859         yielded=0;
<a name="l00860"></a>00860     <span class="keywordflow">else</span>
<a name="l00861"></a>00861         yielded-=<a class="code" href="helix__config_8h.html#a15325bbf6b4381e66b02c77520b8a0dd" title="The number of cycles a context switch costs, used to calculated spare time after Yield().">CONTEXT_SWITCH_CYCLE_PANELTY</a>;
<a name="l00862"></a>00862     
<a name="l00863"></a>00863     <span class="comment">// store time that can be reused</span>
<a name="l00864"></a>00864 <span class="preprocessor">#ifndef SCHEDULE_SLOTS</span>
<a name="l00865"></a>00865 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>=yielded;
<a name="l00866"></a>00866     <span class="comment">// trigger interrupt</span>
<a name="l00867"></a>00867     <a class="code" href="io_8h.html#addab75fc1cac75af9faa313752db39bc" title="Sets the local timer to the designated number of clock cycles.">kSetTimer</a>(2);   <span class="comment">// setting to 1 might be a bit funky...</span>
<a name="l00868"></a>00868 <span class="preprocessor">#else</span>
<a name="l00869"></a>00869 <span class="preprocessor"></span>    <a class="code" href="device_8h.html#a9bee50cd4932d45ad1d8ac8e93d42446">lastart</a>((<span class="keywordtype">int</span>*)&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>);
<a name="l00870"></a>00870     sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>=1;
<a name="l00871"></a>00871     <span class="comment">// 1) When interrupted here, the process will loose the rest of its slice.</span>
<a name="l00872"></a>00872     <span class="comment">// This is not really a problem, the process yielded anyway.</span>
<a name="l00873"></a>00873     barrier();
<a name="l00874"></a>00874     <a class="code" href="device_8h.html#a8f989d80690acfefbf6100474b50861c">laend</a>((<span class="keywordtype">int</span>*)&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>,yielded&lt;<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>?0:yielded);
<a name="l00875"></a>00875     <span class="comment">// 2) When interrupted here without interrupting at 1), everything is OK</span>
<a name="l00876"></a>00876     <span class="comment">// When also at 1) an interrupt occurred, the process&#39;s timeslice is seriously extended,</span>
<a name="l00877"></a>00877     <span class="comment">// therefore, it is guarded by lastart/laend.</span>
<a name="l00878"></a>00878     barrier();
<a name="l00879"></a>00879     <span class="comment">// 3) When interrupted here, everything is OK, but the next call will shorten </span>
<a name="l00880"></a>00880     <span class="comment">// the process&#39;s timeslice by the length of the schedule slot. That&#39;s not a problem.</span>
<a name="l00881"></a>00881     <a class="code" href="io_8h.html#addab75fc1cac75af9faa313752db39bc" title="Sets the local timer to the designated number of clock cycles.">kSetTimer</a>(2,<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>);
<a name="l00882"></a>00882 <span class="preprocessor">#endif</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 <span class="comment"></span>
<a name="l00886"></a>00886 <span class="comment">/*!</span>
<a name="l00887"></a>00887 <span class="comment"> * \brief Suspends current process until one of the non-masked signals occur.</span>
<a name="l00888"></a>00888 <span class="comment"> * \details Cannot be called from within a signal handler</span>
<a name="l00889"></a>00889 <span class="comment"> * \param mask ignore all signals specified in this set (NULL=no mask)</span>
<a name="l00890"></a>00890 <span class="comment"> * \param wait_sticky keep suspended until one of the wait_sticky sticky signals were triggered (NULL or none set=don&#39;t care; continue on any signal)</span>
<a name="l00891"></a>00891 <span class="comment"> */</span>
<a name="l00892"></a><a class="code" href="kernel_8cc.html#a3eb42bba3fa00f76d1a1b1ac584cfea7">00892</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a521dc76dcddd1282082c6b7f8e1e569a" title="Suspends current process until one of the non-masked signals occur.">kSuspend</a>(<span class="keyword">const</span> <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a> *mask,<span class="keyword">const</span> <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a>* wait_sticky){
<a name="l00893"></a>00893 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="kernel_8cc.html#a0d73b8a648a1501b4a09c11bfd9c819c">kIsInSigHandler</a>(<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>))
<a name="l00895"></a>00895         <span class="keywordflow">return</span> ENOTSUP;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a> newmask=mask?*mask:0,oldmask;
<a name="l00898"></a>00898     <span class="keywordtype">int</span> res=<a class="code" href="kernel_8h.html#a77f9091c0d09a555bfe33794fa338b59">kMaskSignal</a>(<a class="code" href="signal_8h.html#a927f6ae16379576d638006c7498ac5d7">SIG_BLOCK</a>,&amp;newmask,&amp;oldmask);
<a name="l00899"></a>00899     <span class="keywordflow">if</span>(res)
<a name="l00900"></a>00900         <span class="keywordflow">return</span> res;
<a name="l00901"></a>00901     
<a name="l00902"></a>00902     res=<a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <span class="keyword">const</span> <span class="keywordtype">int</span> wait_for_sticky=
<a name="l00905"></a>00905         <span class="comment">// take all non-masked signals</span>
<a name="l00906"></a>00906         (mask?~(*mask):-1) &amp; 
<a name="l00907"></a>00907         <span class="comment">// and all signals to wait for</span>
<a name="l00908"></a>00908         (wait_sticky?*wait_sticky:0) &amp;
<a name="l00909"></a>00909         <span class="comment">// check stickyness</span>
<a name="l00910"></a>00910         <a class="code" href="signal_8h.html#a9e84054b8a06c04ed727ce385caa94aa">SIG_STICKY</a>;
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a> sticky_fired=0;
<a name="l00913"></a>00913     <span class="keywordflow">do</span>{
<a name="l00914"></a>00914         <span class="comment">// set to SUSPENDED when no sticky signals have been set</span>
<a name="l00915"></a>00915         <span class="keywordflow">if</span>(!(lcondset_mask((<span class="keywordtype">int</span>*)&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#acc13ca1a2f2a47b66dececa119dd6cff">sig_sticky</a>,wait_for_sticky,(<span class="keywordtype">int</span>*)(<span class="keywordtype">void</span>*)&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>,<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1c2114335a42993ac5cc5dbf65f83d41" title="process waits for signal">SUSPENDED</a>,<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>)&amp;wait_for_sticky))
<a name="l00916"></a>00916             <span class="comment">// no sticky signals have been set, state is now SUSPENDED, give up timeslice</span>
<a name="l00917"></a>00917             res=<a class="code" href="kernel_8h.html#ab91f44b41a9180f07267ac1ead6dfdbd" title="Forcably ends the timeslice of the current process.">kYield</a>(<span class="keyword">false</span>);
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         <span class="comment">// at this point, state is RUNNING (again)</span>
<a name="l00920"></a>00920         <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>,<span class="stringliteral">&quot;Still suspended after trigger&quot;</span>);
<a name="l00921"></a>00921         <span class="comment">// clear sticky signals</span>
<a name="l00922"></a>00922         <span class="keywordflow">if</span>(wait_for_sticky)
<a name="l00923"></a>00923             sticky_fired=(<a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a>)<a class="code" href="device_8h.html#a7e59f4e6ec80c56ae6e15712896be5e3">launset</a>((<span class="keywordtype">int</span>*)&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#acc13ca1a2f2a47b66dececa119dd6cff">sig_sticky</a>,wait_for_sticky)&amp;wait_for_sticky;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         <span class="comment">// if waiting for sticky signals, keep suspended until one of them is fired</span>
<a name="l00926"></a>00926     }<span class="keywordflow">while</span>(wait_for_sticky!=0 &amp;&amp; sticky_fired==0);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <a class="code" href="kernel_8h.html#a77f9091c0d09a555bfe33794fa338b59">kMaskSignal</a>(<a class="code" href="signal_8h.html#a37750b78b7ae75fe02ad26e70f6cc845">SIG_SETMASK</a>,&amp;oldmask,NULL);
<a name="l00929"></a>00929     <span class="comment">// done</span>
<a name="l00930"></a>00930     <span class="keywordflow">return</span> res?res:EINTR;
<a name="l00931"></a>00931 <span class="preprocessor">#else</span>
<a name="l00932"></a>00932 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#ab91f44b41a9180f07267ac1ead6dfdbd" title="Forcably ends the timeslice of the current process.">kYield</a>(<span class="keyword">false</span>);
<a name="l00933"></a>00933     <span class="keywordflow">return</span> ENOSYS;
<a name="l00934"></a>00934 <span class="preprocessor">#endif</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span>}
<a name="l00936"></a>00936 <span class="comment"></span>
<a name="l00937"></a>00937 <span class="comment">/*!</span>
<a name="l00938"></a>00938 <span class="comment"> * \brief Ends the current process.</span>
<a name="l00939"></a>00939 <span class="comment"> * \details Will be called automatically when the main function of a process returns.</span>
<a name="l00940"></a>00940 <span class="comment"> *          The timeslice will always be ended by a call to kYield().</span>
<a name="l00941"></a>00941 <span class="comment"> * \param ret the value returned by the main of the process, which can be retrieved using kJoinProcess() and kDestroyProcess()</span>
<a name="l00942"></a>00942 <span class="comment"> * \return never</span>
<a name="l00943"></a>00943 <span class="comment"> */</span>
<a name="l00944"></a><a class="code" href="kernel_8cc.html#a4a51a3c1e9b2168b41774cb8d58dfe19">00944</a> <span class="keywordtype">void</span> <a class="code" href="kernel_8h.html#a6a76bb371ca312615ba5c5f33046b6c6" title="Ends the current process.">kEndProcess</a>(<span class="keywordtype">void</span>* ret){
<a name="l00945"></a>00945 <span class="preprocessor">#ifdef MEASURE_STACK_USAGE</span>
<a name="l00946"></a>00946 <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s;
<a name="l00947"></a>00947     <span class="keywordflow">for</span>(s=0;s&lt;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a43ad7b82f9c1ec3635f6e7c0a1d6396f" title="maximum stack use">min_stack</a>/<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int) &amp;&amp; ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af75ad68d0a83c9a5f0814478e2553c67" title="stack of this process, malloced in processor heap">stack</a>)[s]==<a class="code" href="kernel_8cc.html#adb8d91529f94de9573a88c3b8514ac6f">STACK_PROTECTION_VALUE</a>;s++);
<a name="l00948"></a>00948     <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a43ad7b82f9c1ec3635f6e7c0a1d6396f" title="maximum stack use">min_stack</a>=s*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int);
<a name="l00949"></a>00949 <span class="preprocessor">#endif</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span>
<a name="l00951"></a>00951 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l00952"></a>00952 <span class="preprocessor"></span>    <a class="code" href="kernel_8h.html#a69471a3ff8b448af4172f71d74bed723" title="thread-local reentrancy struct of newlib, must point to process&#39;s proc_table_t::impure_data">_impure_ptr</a>=<a class="code" href="kernel_8cc.html#aea5a41e11c90591e0e82309d15680c19" title="Pointer to global_impure_data.">_kernel_impure_ptr</a>;
<a name="l00953"></a>00953     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()==0)
<a name="l00954"></a>00954         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;TaskDaemon terminated!&quot;</span>);
<a name="l00955"></a>00955     <span class="keywordflow">if</span>(ret)
<a name="l00956"></a>00956         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;Process %d@%d exited with %p (context: %p, main: %p)\n&quot;</span>,<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>(),<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>(),ret,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a1bf966e47dedb9f9fe54269ea1ac884e" title="entry point of the process">main</a>);
<a name="l00957"></a>00957 <span class="preprocessor">#endif</span>
<a name="l00958"></a>00958 <span class="preprocessor"></span>
<a name="l00959"></a>00959     <span class="comment">// stop this process</span>
<a name="l00960"></a>00960     <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a6d4e3f184a6a952ef80869a2f17349bb" title="return value of the process when it dies">ret</a>=ret;
<a name="l00961"></a>00961     barrier();
<a name="l00962"></a>00962     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>&amp;<a class="code" href="kernel__types_8h.html#a4bf7449d0fffceaa9e6f615be6abc358" title="indicates that the process will be JOINABLE when it ends">PROC_FLAG_JOINABLE</a>)
<a name="l00963"></a>00963         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a95e3221d7fa874623eb789940f39c932" title="process has ended, but waits until kJoinProcess() is called">JOINABLE</a>;
<a name="l00964"></a>00964     <span class="keywordflow">else</span>
<a name="l00965"></a>00965         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a5dfb36109b24f39d54d5c3f48f53def8" title="process has ended, but not cleaned up">ZOMBIE</a>;
<a name="l00966"></a>00966     <a class="code" href="kernel_8h.html#ab91f44b41a9180f07267ac1ead6dfdbd" title="Forcably ends the timeslice of the current process.">kYield</a>();
<a name="l00967"></a>00967     <span class="keywordflow">while</span>(<span class="keyword">true</span>);
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 <span class="comment"></span>
<a name="l00970"></a>00970 <span class="comment">/*!</span>
<a name="l00971"></a>00971 <span class="comment"> * \brief Joins a #JOINABLE process.</span>
<a name="l00972"></a>00972 <span class="comment"> * </span>
<a name="l00973"></a>00973 <span class="comment"> * Gets the return value of the process to join.</span>
<a name="l00974"></a>00974 <span class="comment"> * Never blocks, so wrap in a loop when it is intended to wait until the process finishes.</span>
<a name="l00975"></a>00975 <span class="comment"> * A #JOINABLE process will become a #ZOMBIE when the join is successful.</span>
<a name="l00976"></a>00976 <span class="comment"> * The function is not thread-safe.</span>
<a name="l00977"></a>00977 <span class="comment"> *</span>
<a name="l00978"></a>00978 <span class="comment"> * \param pid process to join</span>
<a name="l00979"></a>00979 <span class="comment"> * \param ret pointer to store the return value of the process to join, can be NULL</span>
<a name="l00980"></a>00980 <span class="comment"> * \return 0 on success, EAGAIN when pid was not #JOINABLE, otherwise an appropiate errno</span>
<a name="l00981"></a>00981 <span class="comment"> */</span>
<a name="l00982"></a><a class="code" href="kernel_8cc.html#a69abcace8557e0ed8d087fe69b218894">00982</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a4fbbe789408d7257af2f3b0bd73bf9ef" title="Joins a JOINABLE process.">kJoinProcess</a>(pid_t pid,<span class="keywordtype">void</span>** ret){
<a name="l00983"></a>00983     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l00984"></a>00984         <span class="keywordflow">return</span> ESRCH;
<a name="l00985"></a>00985     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l00986"></a>00986     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l00987"></a>00987         <span class="keywordflow">return</span> ESRCH;
<a name="l00988"></a>00988     <span class="keywordflow">if</span>(!(pt-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>&amp;<a class="code" href="kernel__types_8h.html#a4bf7449d0fffceaa9e6f615be6abc358" title="indicates that the process will be JOINABLE when it ends">PROC_FLAG_JOINABLE</a>))
<a name="l00989"></a>00989         <span class="keywordflow">return</span> EINVAL;
<a name="l00990"></a>00990     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>!=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a95e3221d7fa874623eb789940f39c932" title="process has ended, but waits until kJoinProcess() is called">JOINABLE</a>)
<a name="l00991"></a>00991         <span class="keywordflow">return</span> EAGAIN;
<a name="l00992"></a>00992     <span class="comment">// join</span>
<a name="l00993"></a>00993     <span class="keywordflow">if</span>(ret)
<a name="l00994"></a>00994         *ret=pt-&gt;<a class="code" href="struct__proc__table__t.html#a6d4e3f184a6a952ef80869a2f17349bb" title="return value of the process when it dies">ret</a>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="comment">// Since the join can be executed by any process and the default task daemon</span>
<a name="l00997"></a>00997     <span class="comment">// reacts on zombie processes, make sure that everything as been cleaned up</span>
<a name="l00998"></a>00998     <span class="comment">// before changing this state. Otherwise, nasty things can happen when an</span>
<a name="l00999"></a>00999     <span class="comment">// context switch occures and a new process is created using this pt.</span>
<a name="l01000"></a>01000     barrier();
<a name="l01001"></a>01001     pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a5dfb36109b24f39d54d5c3f48f53def8" title="process has ended, but not cleaned up">ZOMBIE</a>;
<a name="l01002"></a>01002     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 <span class="comment"></span>
<a name="l01005"></a>01005 <span class="comment">/*!</span>
<a name="l01006"></a>01006 <span class="comment"> * \brief Destroys and clean up a process.</span>
<a name="l01007"></a>01007 <span class="comment"> *</span>
<a name="l01008"></a>01008 <span class="comment"> * Only the task daemon is allowed to destroy processes.</span>
<a name="l01009"></a>01009 <span class="comment"> * All allocated memory will be freeed.</span>
<a name="l01010"></a>01010 <span class="comment"> * Process statistics is not deleted, so after destroying a process, kGetProcessStats() can be called.</span>
<a name="l01011"></a>01011 <span class="comment"> * A process cannot destroy itself.</span>
<a name="l01012"></a>01012 <span class="comment"> *</span>
<a name="l01013"></a>01013 <span class="comment"> * \param pid process to destroy</span>
<a name="l01014"></a>01014 <span class="comment"> * \param ret a pointer to store the return value of the process, can be NULL, holds unknown data when a non-#ZOMBIE process is destroyed</span>
<a name="l01015"></a>01015 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l01016"></a>01016 <span class="comment"> */</span>
<a name="l01017"></a><a class="code" href="kernel_8cc.html#a0384b3a8ec4a91e91895ae9c44b24c56">01017</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a847a95e0b86135a016db40def9286aa4" title="Destroys and clean up a process.">kDestroyProcess</a>(pid_t pid,<span class="keywordtype">void</span>** ret){
<a name="l01018"></a>01018     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()!=0)
<a name="l01019"></a>01019         <span class="keywordflow">return</span> EPERM;
<a name="l01020"></a>01020     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01021"></a>01021         <span class="keywordflow">return</span> ESRCH;
<a name="l01022"></a>01022     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()==pid)
<a name="l01023"></a>01023         <span class="keywordflow">return</span> EINVAL;
<a name="l01024"></a>01024     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01025"></a>01025     <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l01026"></a>01026         <span class="keywordflow">return</span> ESRCH;
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="comment">// make sure that it won&#39;t be scheduled before the memory is freed.</span>
<a name="l01029"></a>01029     pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a5dfb36109b24f39d54d5c3f48f53def8" title="process has ended, but not cleaned up">ZOMBIE</a>;
<a name="l01030"></a>01030     barrier();
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     <a class="code" href="malloc_8h.html#acda9068dcab43436bee8a1e409ee6275">freeAll</a>(pid);
<a name="l01033"></a>01033     <a class="code" href="malloc_8h.html#a63a1bb5bd351c6fa332536c697bb9b31">ffreeAll</a>(pid);
<a name="l01034"></a>01034     <span class="keywordflow">if</span>(ret)
<a name="l01035"></a>01035         *ret=pt-&gt;<a class="code" href="struct__proc__table__t.html#a6d4e3f184a6a952ef80869a2f17349bb" title="return value of the process when it dies">ret</a>;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="comment">// update schedule</span>
<a name="l01038"></a>01038 <span class="preprocessor">#ifdef SCHEDULE_SLOTS</span>
<a name="l01039"></a>01039 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(pt-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>!=<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>)
<a name="l01040"></a>01040         <span class="comment">// prev_entry of the task daemon is used for other purposes; do no overwrite in that case</span>
<a name="l01041"></a>01041 <span class="preprocessor">#endif</span>
<a name="l01042"></a>01042 <span class="preprocessor"></span>        pt-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>;
<a name="l01043"></a>01043     pt-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>;  
<a name="l01044"></a>01044     barrier();
<a name="l01045"></a>01045     pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>;
<a name="l01046"></a>01046     
<a name="l01047"></a>01047     <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>)
<a name="l01048"></a>01048         <a class="code" href="mc_8h.html#a031261eaad96e3eaafac6c1c9ba923ac">mc_apply</a>(sch.<a class="code" href="structsch__t.html#af8400bce0840f9e19743802188d12c14">pthread_sch</a>-&gt;<a class="code" href="structpthread__sch__t.html#a916f62e6eaafb138c53e469e3959ac60">processes</a>,--);
<a name="l01049"></a>01049 
<a name="l01050"></a>01050     <span class="comment">// trace the destruction of this process</span>
<a name="l01051"></a>01051     <a class="code" href="trace_8h.html#ad8b20224245a6b119b546a378096b142" title="Signals a change in the process information.">kTraceProcChange</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>,pid,0,(<span class="keywordtype">void</span>*)NULL);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01054"></a>01054 }
<a name="l01055"></a>01055 <span class="comment"></span>
<a name="l01056"></a>01056 <span class="comment">/*!</span>
<a name="l01057"></a>01057 <span class="comment"> * \brief Looks for a #ZOMBIE process and destroys it.</span>
<a name="l01058"></a>01058 <span class="comment"> * </span>
<a name="l01059"></a>01059 <span class="comment"> * Walks over all processes and cleans up the first #ZOMBIE process it can find.</span>
<a name="l01060"></a>01060 <span class="comment"> * Only the task daemon is allowed to call the function.</span>
<a name="l01061"></a>01061 <span class="comment"> *</span>
<a name="l01062"></a>01062 <span class="comment"> * \param pid the process that has been cleaned up, can be NULL</span>
<a name="l01063"></a>01063 <span class="comment"> * \param ret pointer to store the return value of the process in, can be NULL</span>
<a name="l01064"></a>01064 <span class="comment"> * \return 0 on success, EAGAIN when no ZOMBIEs has been found, otherwise an appropriate errno</span>
<a name="l01065"></a>01065 <span class="comment"> */</span>
<a name="l01066"></a><a class="code" href="kernel_8cc.html#a0e8f4c610eb9ed8186e3bbf84b22ccc2">01066</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a9bb60bc432a67999340bf2a27ae120e6" title="Looks for a ZOMBIE process and destroys it.">kGetZombie</a>(pid_t *pid,<span class="keywordtype">void</span>** ret){
<a name="l01067"></a>01067     pid_t zpid;
<a name="l01068"></a>01068     <span class="comment">// only the TaskDaemon is allowed to modify the process table</span>
<a name="l01069"></a>01069     <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()!=0)
<a name="l01070"></a>01070         <span class="keywordflow">return</span> EPERM;
<a name="l01071"></a>01071     <span class="comment">// find first zombie</span>
<a name="l01072"></a>01072     <span class="keywordflow">for</span>(zpid=0;zpid&lt;<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a> &amp;&amp; <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[zpid].<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>!=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a5dfb36109b24f39d54d5c3f48f53def8" title="process has ended, but not cleaned up">ZOMBIE</a>;zpid++);
<a name="l01073"></a>01073     <span class="keywordflow">if</span>(zpid==<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01074"></a>01074         <span class="keywordflow">return</span> EAGAIN;
<a name="l01075"></a>01075     <span class="keywordflow">if</span>(pid)
<a name="l01076"></a>01076         *pid=zpid;
<a name="l01077"></a>01077     <span class="comment">// clean up zombie process</span>
<a name="l01078"></a>01078     <span class="keywordflow">return</span> <a class="code" href="kernel_8h.html#a847a95e0b86135a016db40def9286aa4" title="Destroys and clean up a process.">kDestroyProcess</a>(zpid,ret);
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 <span class="comment"></span>
<a name="l01081"></a>01081 <span class="comment">/*!</span>
<a name="l01082"></a>01082 <span class="comment"> * \brief Collects statistics of the specified process.</span>
<a name="l01083"></a>01083 <span class="comment"> * \param pid the process to collect statistics of (can be an non-existing process)</span>
<a name="l01084"></a>01084 <span class="comment"> * \param stats pointer to struct to write statistics to</span>
<a name="l01085"></a>01085 <span class="comment"> * \returns 0 on success, otherwise an errno</span>
<a name="l01086"></a>01086 <span class="comment"> */</span>
<a name="l01087"></a><a class="code" href="kernel_8cc.html#aef090d8ae57af08c116c6ef8a94e5747">01087</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a4a36797d67315bf7782dd5a6fbffabb8" title="Collects statistics of the specified process.">kGetProcessStats</a>(pid_t pid,<a class="code" href="structproc__stats__t.html">proc_stats_t</a>* stats){
<a name="l01088"></a>01088     <span class="keywordflow">if</span>(stats==NULL)
<a name="l01089"></a>01089         <span class="keywordflow">return</span> EINVAL;
<a name="l01090"></a>01090     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01091"></a>01091         <span class="keywordflow">return</span> ESRCH;
<a name="l01092"></a>01092     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* pt=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01093"></a>01093     stats-&gt;<a class="code" href="structproc__stats__t.html#a074aa753faf1abe363cc93617e69c268">pid</a>=<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>;
<a name="l01094"></a>01094     stats-&gt;<a class="code" href="structproc__stats__t.html#aa99d9350b827e8319e36f0cf5b290114">state</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>;
<a name="l01095"></a>01095     stats-&gt;<a class="code" href="structproc__stats__t.html#aa0ba99487db40757206e40760f040a3f">insighandler</a>=<a class="code" href="kernel_8cc.html#a0d73b8a648a1501b4a09c11bfd9c819c">kIsInSigHandler</a>(pt);
<a name="l01096"></a>01096     stats-&gt;<a class="code" href="structproc__stats__t.html#a6549aa8529c68898745feac24bc9ecb4">context</a>=&amp;pt-&gt;<a class="code" href="struct__proc__table__t.html#aaa93be5012a07072558257063612c6b5" title="processor context of this process">context</a>;
<a name="l01097"></a>01097     stats-&gt;<a class="code" href="structproc__stats__t.html#ac97e1fb554cd43f5838856e1b43fab4d">main</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#a1bf966e47dedb9f9fe54269ea1ac884e" title="entry point of the process">main</a>;
<a name="l01098"></a>01098     stats-&gt;<a class="code" href="structproc__stats__t.html#ab2228470b5e40edacfd2aa4cd25aca29">flags</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     <a class="code" href="kernel__types_8h.html#a77e49d03a1e611dab893961ac9886155" title="type of scheduler timer, used internally">timeslice_t</a> ticks_in_ms=<a class="code" href="device_8h.html#a849ce054a843c28398da5b40f0918e77" title="Returns the clock frequency of the current core in Hz.">GetClockFreq</a>()/1000;
<a name="l01101"></a>01101     stats-&gt;<a class="code" href="structproc__stats__t.html#a02138c6f42134e79dcf40c3b47460b83">slice_length</a>=(<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a>)(pt-&gt;<a class="code" href="struct__proc__table__t.html#aa96b0dad43ede9e43c248df892370e12" title="assigned time slot size">time</a>/ticks_in_ms);
<a name="l01102"></a>01102 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01103"></a>01103 <span class="preprocessor"></span>    stats-&gt;<a class="code" href="structproc__stats__t.html#aa5ad3d8cebefcba35fbf398a09a2eac6">slice_slack</a>=(<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a>)(pt-&gt;<a class="code" href="struct__proc__table__t.html#ac9c6ed46b712dd9ad7f53f5c670dc895" title="slack time Yield()ed">slack</a>/ticks_in_ms);
<a name="l01104"></a>01104 <span class="preprocessor">#ifdef SCHEDULE_SLOTS</span>
<a name="l01105"></a>01105 <span class="preprocessor"></span>    stats-&gt;<a class="code" href="structproc__stats__t.html#a6cc5bfae25ac293872ed743f5e6a6dd8">slice_used</a>=(<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a>)((pt-&gt;<a class="code" href="struct__proc__table__t.html#a60743fea7445a85d6c0184f504ddcf58" title="total time allocated">time_alloc</a>*<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>-pt-&gt;<a class="code" href="struct__proc__table__t.html#ac9c6ed46b712dd9ad7f53f5c670dc895" title="slack time Yield()ed">slack</a>)/ticks_in_ms);
<a name="l01106"></a>01106 <span class="preprocessor">#else</span>
<a name="l01107"></a>01107 <span class="preprocessor"></span>    stats-&gt;<a class="code" href="structproc__stats__t.html#a6cc5bfae25ac293872ed743f5e6a6dd8">slice_used</a>=(<a class="code" href="kernel__types_8h.html#aab831218703b6d40fa14bd6ec1d2fcac" title="type of the timeslice length, used in interface">timems_t</a>)((pt-&gt;<a class="code" href="struct__proc__table__t.html#a60743fea7445a85d6c0184f504ddcf58" title="total time allocated">time_alloc</a>-pt-&gt;<a class="code" href="struct__proc__table__t.html#ac9c6ed46b712dd9ad7f53f5c670dc895" title="slack time Yield()ed">slack</a>)/ticks_in_ms);
<a name="l01108"></a>01108 <span class="preprocessor">#endif</span>
<a name="l01109"></a>01109 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01110"></a>01110 <span class="preprocessor"></span>
<a name="l01111"></a>01111 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01112"></a>01112 <span class="preprocessor"></span>    stats-&gt;<a class="code" href="structproc__stats__t.html#ad90404e4c82db5c90e6fa8dd68eb90df">min_stack</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#a43ad7b82f9c1ec3635f6e7c0a1d6396f" title="maximum stack use">min_stack</a>;
<a name="l01113"></a>01113     stats-&gt;<a class="code" href="structproc__stats__t.html#a0ebc885dc1b0816e9789c6a580d13ec6">context_switches</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#ac74c6973267778662c83dfadc1816577" title="number of context switches">context_switches</a>;
<a name="l01114"></a>01114     stats-&gt;<a class="code" href="structproc__stats__t.html#a0f01c62683a12c0c9fd2b6cb54df874b">yields</a>=pt-&gt;<a class="code" href="struct__proc__table__t.html#a4e465f239d5faa916030d74febb62511" title="number of Yield()s">yields</a>;
<a name="l01115"></a>01115 <span class="preprocessor">#endif</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 <span class="comment"></span>
<a name="l01119"></a>01119 <span class="comment">/*!</span>
<a name="l01120"></a>01120 <span class="comment"> * \brief Prints complete state of the current process and the kernel.</span>
<a name="l01121"></a>01121 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l01122"></a>01122 <span class="comment"> */</span>
<a name="l01123"></a><a class="code" href="kernel_8cc.html#a80bee10ed63d2e9e67b09f4a9ef17d09">01123</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a468106d328ee635cdc50e1fad751b655" title="Prints complete state of the current process and the kernel.">kCoreDump</a>(){
<a name="l01124"></a>01124     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot; * Core dump of state during last interrupt\n&quot;</span>);
<a name="l01125"></a>01125     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;current_proc    : %p @ processor %d\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>,<a class="code" href="device_8h.html#a03019be38c75a4741a5351cff1776f64">GetProcID</a>());
<a name="l01126"></a>01126     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;os state        : %d\n&quot;</span>,<a class="code" href="kernel_8h.html#a4848c8aa831a1d731eddd2813cb5c97e">GetOSState</a>());
<a name="l01127"></a>01127     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;kernel_context  : %p\n&quot;</span>,<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>);
<a name="l01128"></a>01128     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;current_context : %p\n&quot;</span>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>);
<a name="l01129"></a>01129     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;current process : %d\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a2a1920067f74dd25917973ce22da4540" title="process ID of this process">pid</a>);
<a name="l01130"></a>01130     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;state           : %d\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>);
<a name="l01131"></a>01131     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;slice           : %u cycles@%dMHz\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#aa96b0dad43ede9e43c248df892370e12" title="assigned time slot size">time</a>,<a class="code" href="device_8h.html#a849ce054a843c28398da5b40f0918e77" title="Returns the clock frequency of the current core in Hz.">GetClockFreq</a>()/1000000);
<a name="l01132"></a>01132     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;yielded         : %u cycles\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>);
<a name="l01133"></a>01133     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;&amp;main           : %p\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a1bf966e47dedb9f9fe54269ea1ac884e" title="entry point of the process">main</a>);
<a name="l01134"></a>01134     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;stack           : %p\n&quot;</span>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af75ad68d0a83c9a5f0814478e2553c67" title="stack of this process, malloced in processor heap">stack</a>);
<a name="l01135"></a>01135     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> reg=0;reg&lt;8;reg++){
<a name="l01136"></a>01136         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;r%-2d : 0x%08X     &quot;</span>,reg,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[reg]);
<a name="l01137"></a>01137         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;r%-2d : 0x%08X     &quot;</span>,reg+8,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[reg+8]);
<a name="l01138"></a>01138         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;r%-2d : 0x%08X     &quot;</span>,reg+16,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[reg+16]);
<a name="l01139"></a>01139         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;r%-2d : 0x%08X\n&quot;</span>,reg+24,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[reg+24]);
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;MSR : 0x%08X\n&quot;</span>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#af5e55b0ff077b4af36d3fa4ba26579d4" title="Machine State Register (of the MicroBlaze)">msr</a>);
<a name="l01142"></a>01142     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;FSR : 0x%08X\n&quot;</span>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#a1bcca3429b2a3121684f8af68e8bf618" title="Floating point unit State Register (of the MicroBlaze)">fsr</a>);
<a name="l01143"></a>01143     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;PC  : 0x%08X (=r14)\n&quot;</span>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[14]);
<a name="l01144"></a>01144     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;SP  : 0x%08X (=r1)\n&quot;</span>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[1]);
<a name="l01145"></a>01145     <span class="keywordflow">if</span>(<a class="code" href="kernel_8cc.html#a84f421f490b8753b261209ac5b8485de">IS_VALID_DDR_PTR</a>(<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[1]))
<a name="l01146"></a>01146         <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;[SP]: 0x%08X\n&quot;</span>,*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[1])));
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;\nProcess table:\n&quot;</span>);
<a name="l01149"></a>01149     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>;i++){
<a name="l01150"></a>01150         <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a> *p=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[i];
<a name="l01151"></a>01151 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>        <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot; %2d (%10p): state=%d flags=%d minstack=0x%04x\n&quot;</span>,i,p,p-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>,p-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>,p-&gt;<a class="code" href="struct__proc__table__t.html#a43ad7b82f9c1ec3635f6e7c0a1d6396f" title="maximum stack use">min_stack</a>);
<a name="l01153"></a>01153 <span class="preprocessor">#else</span>
<a name="l01154"></a>01154 <span class="preprocessor"></span>        <a class="code" href="kernel_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot; %2d (%10p): state=%d flags=%d\n&quot;</span>,i,p,p-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>,p-&gt;<a class="code" href="struct__proc__table__t.html#ac382c327204c8c37fdf9d149a48c14d1" title="all flags of this process">flags</a>);
<a name="l01155"></a>01155 <span class="preprocessor">#endif</span>
<a name="l01156"></a>01156 <span class="preprocessor"></span>    }
<a name="l01157"></a>01157     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a><a class="code" href="kernel_8cc.html#ad231b0c7ac743c5863b33833aa1f38d1">01160</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#aabd8253bbdfe1e1389691b7c7f830236">kGetProcLocal</a>(<a class="code" href="structproc__local__t.html">proc_local_t</a>** p){
<a name="l01161"></a>01161     <span class="keywordflow">if</span>(p){
<a name="l01162"></a>01162         *p=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a32f1b12c47aa10f73b3fed4594af9d31">proc_local</a>;
<a name="l01163"></a>01163         <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01164"></a>01164     }<span class="keywordflow">else</span>{
<a name="l01165"></a>01165         <span class="keywordflow">return</span> EINVAL;
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167 }
<a name="l01168"></a>01168 <span class="comment"></span>
<a name="l01169"></a>01169 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l01170"></a>01170 <span class="comment"></span><span class="comment">// Process I/O</span><span class="comment"></span>
<a name="l01171"></a>01171 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l01172"></a>01172 <span class="comment"></span><span class="comment"></span>
<a name="l01173"></a>01173 <span class="comment">/*!</span>
<a name="l01174"></a>01174 <span class="comment"> * \brief Returns the number of allocated channels.</span>
<a name="l01175"></a>01175 <span class="comment"> * \details This does not indicate whether channels are assigned or in use.</span>
<a name="l01176"></a>01176 <span class="comment"> * \param pid the process to get the information of</span>
<a name="l01177"></a>01177 <span class="comment"> * \return The channel count or -1 when an invalid pid is supplied</span>
<a name="l01178"></a>01178 <span class="comment"> */</span>
<a name="l01179"></a><a class="code" href="kernel_8cc.html#aec8e991b381e779071c8d296db5a5215">01179</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a8d0d0f8624a055770a9428bd043fd6a5" title="Returns the number of allocated channels.">kGetChannelCount</a>(pid_t pid){
<a name="l01180"></a>01180     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01181"></a>01181         <span class="keywordflow">return</span> ESRCH;
<a name="l01182"></a>01182     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01183"></a>01183     <span class="keywordflow">if</span>(proc-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484aa44ad9fa6428540f9b54bb7f946f8709" title="invalid process">NOPROC</a>)
<a name="l01184"></a>01184         <span class="keywordflow">return</span> -1;
<a name="l01185"></a>01185     <span class="keywordflow">if</span>(proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>==NULL)
<a name="l01186"></a>01186         <span class="keywordflow">return</span> 0;
<a name="l01187"></a>01187     <span class="keywordflow">else</span>
<a name="l01188"></a>01188         <span class="keywordflow">return</span> proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>;
<a name="l01189"></a>01189 }
<a name="l01190"></a>01190 <span class="comment"></span>
<a name="l01191"></a>01191 <span class="comment">/*!</span>
<a name="l01192"></a>01192 <span class="comment"> * \brief Allocates memory for channels.</span>
<a name="l01193"></a>01193 <span class="comment"> * \details When called multiple times, the allocated memory will be resized.</span>
<a name="l01194"></a>01194 <span class="comment"> * \param pid process to allocate channel memory for</span>
<a name="l01195"></a>01195 <span class="comment"> * \param num_chan number of channels to allocate, will be initialized to NULL</span>
<a name="l01196"></a>01196 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l01197"></a>01197 <span class="comment"> */</span>
<a name="l01198"></a><a class="code" href="kernel_8cc.html#ad6c2311446d5297aea2a63ebfead05c4">01198</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#ab14b01d3c15d03ac0ec949540990b638" title="Allocates memory for channels.">kAllocChannels</a>(pid_t pid, <span class="keywordtype">int</span> num_chan){
<a name="l01199"></a>01199     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01200"></a>01200         <span class="keywordflow">return</span> ESRCH;
<a name="l01201"></a>01201     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01202"></a>01202     <span class="comment">// allocate memory for channels</span>
<a name="l01203"></a>01203     <a class="code" href="structchannel__t.html">channel_t</a>* newchans=(<a class="code" href="structchannel__t.html">channel_t</a>*)<a class="code" href="malloc_8h.html#ac4a80ba9cc5b6810218f6c16af1dc5bd">orealloc</a>((<span class="keywordtype">void</span>*)proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>,num_chan*<span class="keyword">sizeof</span>(<a class="code" href="structchannel__t.html">channel_t</a>),pid);
<a name="l01204"></a>01204     <span class="keywordflow">if</span>(num_chan!=0 &amp;&amp; newchans==NULL)
<a name="l01205"></a>01205         <span class="keywordflow">return</span> ENOMEM;
<a name="l01206"></a>01206     <span class="comment">// initialize all newly allocated channels to NULL</span>
<a name="l01207"></a>01207     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>;i&lt;num_chan;i++){
<a name="l01208"></a>01208         newchans[i].<a class="code" href="structchannel__t.html#a2ffaf87a684b4a6280c134777a0fbb95">channel</a>=NULL;
<a name="l01209"></a>01209         newchans[i].<a class="code" href="structchannel__t.html#abbbf1b397cccb19852cb504f289c2af3">label</a>=0;
<a name="l01210"></a>01210     }
<a name="l01211"></a>01211     <span class="comment">// update process table</span>
<a name="l01212"></a>01212     proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>=(<span class="keyword">volatile</span> <a class="code" href="structchannel__t.html">channel_t</a>*)newchans;
<a name="l01213"></a>01213     barrier();
<a name="l01214"></a>01214     proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>=num_chan;
<a name="l01215"></a>01215     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01216"></a>01216 }
<a name="l01217"></a>01217 <span class="comment"></span>
<a name="l01218"></a>01218 <span class="comment">/*!</span>
<a name="l01219"></a>01219 <span class="comment"> * \brief Assigns a pointer to a channel.</span>
<a name="l01220"></a>01220 <span class="comment"> * \param pid process to assign a channel to</span>
<a name="l01221"></a>01221 <span class="comment"> * \param chan_id channel to assign the pointer to, must be less than num_chan of a previous kAllocChannels() call, when set to -1, a new channel is allocated at the end of the list</span>
<a name="l01222"></a>01222 <span class="comment"> * \param channel to store in the channel list</span>
<a name="l01223"></a>01223 <span class="comment"> * \param label an alternative label of the channel (set to 0 for no label, all negative labels are reserved by the kernel)</span>
<a name="l01224"></a>01224 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l01225"></a>01225 <span class="comment"> */</span>
<a name="l01226"></a><a class="code" href="kernel_8cc.html#a398cae67ec6b117dfd86abaa6f9575fe">01226</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#aa0cd9e03a6dcd716aa8ec26798d78cb5" title="Assigns a pointer to a channel.">kAssignChannel</a>(pid_t pid, <span class="keywordtype">int</span> chan_id, <span class="keywordtype">void</span>* channel, <span class="keywordtype">int</span> label){
<a name="l01227"></a>01227     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01228"></a>01228         <span class="keywordflow">return</span> ESRCH;
<a name="l01229"></a>01229     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     <span class="keywordflow">if</span>(chan_id&lt;0){
<a name="l01232"></a>01232         <span class="keywordtype">int</span> ret;
<a name="l01233"></a>01233         chan_id=proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>;
<a name="l01234"></a>01234         <span class="keywordflow">if</span>((ret=<a class="code" href="kernel_8h.html#ab14b01d3c15d03ac0ec949540990b638" title="Allocates memory for channels.">kAllocChannels</a>(pid,proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>+1)))
<a name="l01235"></a>01235             <span class="keywordflow">return</span> ret;
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <span class="keywordflow">if</span>(proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>==NULL)
<a name="l01239"></a>01239         <span class="keywordflow">return</span> EAGAIN;
<a name="l01240"></a>01240 
<a name="l01241"></a>01241     <span class="keywordflow">if</span>(chan_id&gt;=(<span class="keywordtype">int</span>)proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>)
<a name="l01242"></a>01242         <span class="keywordflow">return</span> EINVAL;
<a name="l01243"></a>01243     proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>[chan_id].<a class="code" href="structchannel__t.html#a2ffaf87a684b4a6280c134777a0fbb95">channel</a>=channel;
<a name="l01244"></a>01244     proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>[chan_id].<a class="code" href="structchannel__t.html#abbbf1b397cccb19852cb504f289c2af3">label</a>=label;
<a name="l01245"></a>01245     sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l01246"></a>01246     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01247"></a>01247 }
<a name="l01248"></a>01248 <span class="comment"></span>
<a name="l01249"></a>01249 <span class="comment">/*!</span>
<a name="l01250"></a>01250 <span class="comment"> * \brief Sets a new label to an existing channel.</span>
<a name="l01251"></a>01251 <span class="comment"> * \param pid process that has the channel to change the label of</span>
<a name="l01252"></a>01252 <span class="comment"> * \param chan_id the channel to change the label of</span>
<a name="l01253"></a>01253 <span class="comment"> * \param label the new label, where 0 means &#39;no label&#39;</span>
<a name="l01254"></a>01254 <span class="comment"> * \return 0 on success, otherwise an errno</span>
<a name="l01255"></a>01255 <span class="comment"> */</span>
<a name="l01256"></a><a class="code" href="kernel_8cc.html#a7f1df01f20303d8868e74f0989e719a8">01256</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#ae47dc15e48fc1d299d17d1313afc5389" title="Sets a new label to an existing channel.">kSetChannelLabel</a>(pid_t pid, <span class="keywordtype">int</span> chan_id, <span class="keywordtype">int</span> label){
<a name="l01257"></a>01257     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01258"></a>01258         <span class="keywordflow">return</span> ESRCH;
<a name="l01259"></a>01259     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01260"></a>01260     <span class="keywordflow">if</span>(proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>==NULL || chan_id&gt;=(<span class="keywordtype">int</span>)proc-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>)
<a name="l01261"></a>01261         <span class="keywordflow">return</span> EINVAL;
<a name="l01262"></a>01262     proc-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>[chan_id].<a class="code" href="structchannel__t.html#abbbf1b397cccb19852cb504f289c2af3">label</a>=label;
<a name="l01263"></a>01263     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01264"></a>01264 }
<a name="l01265"></a>01265 <span class="comment"></span>
<a name="l01266"></a>01266 <span class="comment">/*!</span>
<a name="l01267"></a>01267 <span class="comment"> * \brief Looks for a channel with the specified label.</span>
<a name="l01268"></a>01268 <span class="comment"> * \param label the label to look for</span>
<a name="l01269"></a>01269 <span class="comment"> * \return the channel id of the channel with the specified label, or -1 when not found</span>
<a name="l01270"></a>01270 <span class="comment"> */</span>
<a name="l01271"></a><a class="code" href="kernel_8cc.html#a211a73673db6a85dbf71f70c0354674a">01271</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#acef551e09938c18b4674915fe9e1a6f8" title="Looks for a channel with the specified label.">kFindChannel</a>(<span class="keywordtype">int</span> label){
<a name="l01272"></a>01272     <span class="keywordflow">if</span>(label==0)
<a name="l01273"></a>01273         <span class="keywordflow">return</span> -1;
<a name="l01274"></a>01274 
<a name="l01275"></a>01275     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=(<span class="keywordtype">int</span>)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>-1;i&gt;=0;i--)
<a name="l01276"></a>01276         <span class="keywordflow">if</span>(label==<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>[i].<a class="code" href="structchannel__t.html#abbbf1b397cccb19852cb504f289c2af3">label</a>)
<a name="l01277"></a>01277             <span class="keywordflow">return</span> i;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     <span class="keywordflow">return</span> -1;
<a name="l01280"></a>01280 }
<a name="l01281"></a>01281 <span class="comment"></span>
<a name="l01282"></a>01282 <span class="comment">/*!</span>
<a name="l01283"></a>01283 <span class="comment"> * \brief Returns the pointer corresponding to the given channel of the current process.</span>
<a name="l01284"></a>01284 <span class="comment"> * \details Blocks and kYield()s until the given channel is not NULL.</span>
<a name="l01285"></a>01285 <span class="comment"> *          Note that the specified channel is not checked for validity.</span>
<a name="l01286"></a>01286 <span class="comment"> * \param channel channel to open</span>
<a name="l01287"></a>01287 <span class="comment"> * \return pointer corresponding to the channel, cannot be NULL</span>
<a name="l01288"></a>01288 <span class="comment"> */</span>
<a name="l01289"></a><a class="code" href="kernel_8cc.html#aa7eb958b6e300d661ca0ba06328505c8">01289</a> <span class="keywordtype">void</span>* <a class="code" href="kernel_8h.html#ab4e2f96359c3bc8e1841cd66ed8fcfec" title="Returns the pointer corresponding to the given channel of the current process.">kOpenChannel</a>(<span class="keywordtype">int</span> channel){
<a name="l01290"></a>01290     <span class="comment">// wait until the channel has been allocated and assigned</span>
<a name="l01291"></a>01291     <span class="keywordflow">while</span>((<span class="keywordtype">int</span>)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a3bcf992b0e518c9786f8d835a57e6a00" title="length of channels list">num_channels</a>&lt;=channel || <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>[channel].<a class="code" href="structchannel__t.html#a2ffaf87a684b4a6280c134777a0fbb95">channel</a>==NULL)
<a name="l01292"></a>01292         <a class="code" href="kernel_8h.html#ab91f44b41a9180f07267ac1ead6dfdbd" title="Forcably ends the timeslice of the current process.">kYield</a>(<span class="keyword">false</span>);
<a name="l01293"></a>01293     <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a7ee308e8c1d1a57189fd2d77e859df7a" title="list of all channels of this process">channels</a>[channel].<a class="code" href="structchannel__t.html#a2ffaf87a684b4a6280c134777a0fbb95">channel</a>;
<a name="l01294"></a>01294 }
<a name="l01295"></a>01295 <span class="comment"></span>
<a name="l01296"></a>01296 <span class="comment">/*!</span>
<a name="l01297"></a>01297 <span class="comment"> * \brief Returns the pointer to the hook table.</span>
<a name="l01298"></a>01298 <span class="comment"> * \details The memory region of the hook table is owned by the TaskDaemon (pid 0).</span>
<a name="l01299"></a>01299 <span class="comment"> * \return cannot be NULL during normal operation (it can be null during kernel initialization, just before the table is initialized)</span>
<a name="l01300"></a>01300 <span class="comment"> */</span>
<a name="l01301"></a><a class="code" href="kernel_8cc.html#a889b2a9246fc945ee2c48e771895cf2f">01301</a> <a class="code" href="hooks_8h.html#a60608a6e577367c4f9928747aea95b56" title="The hook-table type.">hook_t</a>* <a class="code" href="kernel_8h.html#a406d0bdfe086c5eb4cf028f6a560b5b1" title="Returns the pointer to the hook table.">kGetHookTable</a>(){
<a name="l01302"></a>01302     <span class="keywordflow">return</span> <a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;hooks;
<a name="l01303"></a>01303 }
<a name="l01304"></a>01304 
<a name="l01305"></a><a class="code" href="kernel_8cc.html#ad4c9248a1cdf947f15fff528dea46898">01305</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a9dfd100e756d7e2aa7740c8489dda913">kSetSignalHandler</a>(<span class="keywordtype">int</span> signum,<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsigaction.html">sigaction</a>* act){
<a name="l01306"></a>01306 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(signum&lt;=0||signum&gt;<a class="code" href="signal_8h.html#ab83b88daaecc469d1edb90a527ab4a39">NSIG</a>||signum==<a class="code" href="signal_8h.html#a024f43063003e753afc6cca1acd6e104">SIGCONT</a>)
<a name="l01308"></a>01308         <span class="keywordflow">return</span> EINVAL;
<a name="l01309"></a>01309 
<a name="l01310"></a>01310     <span class="keywordflow">if</span>((1&lt;&lt;signum)&amp;<a class="code" href="signal_8h.html#ab415bf0cca749a0c20ce73e903ad64b2">SIG_HANDLEABLE</a>){
<a name="l01311"></a>01311         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad8975ee0bd89cfb79575243bc969ad97">sig_action</a>[signum]=*act;
<a name="l01312"></a>01312         <span class="keywordflow">if</span>(act-&gt;<a class="code" href="structsigaction.html#a0087bff9c76e53abfe8b2a527add0241">sa_handler</a>==SIG_IGN)
<a name="l01313"></a>01313             <a class="code" href="signal_8h.html#a110c596c64bbba573094a3f255dd5eeb">sigdelset</a>(&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#afd1a791b1121f56048cf36af83cd9dc7">sig_enabled</a>,signum);
<a name="l01314"></a>01314         <span class="keywordflow">else</span>
<a name="l01315"></a>01315             <a class="code" href="signal_8h.html#aa5c62f35b5e5762251f53de767250d28">sigaddset</a>(&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#afd1a791b1121f56048cf36af83cd9dc7">sig_enabled</a>,signum);
<a name="l01316"></a>01316         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a93a4e339ba91ac50569513595414c518">sig_triggered</a>[signum]=0;
<a name="l01317"></a>01317         <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01318"></a>01318     }<span class="keywordflow">else</span>
<a name="l01319"></a>01319         <span class="keywordflow">return</span> EINVAL;
<a name="l01320"></a>01320 <span class="preprocessor">#else</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ENOSYS;
<a name="l01322"></a>01322 <span class="preprocessor">#endif</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span>}
<a name="l01324"></a>01324 
<a name="l01325"></a><a class="code" href="kernel_8cc.html#aaefc9f16b529add9146a5b17115b0469">01325</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a6739da9ce3f91745958200c4e5525f4b">kClearSignal</a>(<span class="keywordtype">int</span> signum,<span class="keyword">struct</span> <a class="code" href="structsigaction.html">sigaction</a>* sa){
<a name="l01326"></a>01326 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01327"></a>01327 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(signum&lt;=0||signum&gt;=<a class="code" href="signal_8h.html#ab83b88daaecc469d1edb90a527ab4a39">NSIG</a>)
<a name="l01328"></a>01328         <span class="keywordflow">return</span> EINVAL;
<a name="l01329"></a>01329     <span class="keywordflow">if</span>(!sa)
<a name="l01330"></a>01330         <span class="keywordflow">return</span> EINVAL;
<a name="l01331"></a>01331     
<a name="l01332"></a>01332     *sa=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad8975ee0bd89cfb79575243bc969ad97">sig_action</a>[signum];
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     <span class="comment">// block masks (should be unblocked by the callee by sa-&gt;sa_mask)</span>
<a name="l01335"></a>01335     <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a> mask=sa-&gt;<a class="code" href="structsigaction.html#a684e70081d03d46ce70af097ea5cfd49">sa_mask</a>;
<a name="l01336"></a>01336     <a class="code" href="signal_8h.html#aa5c62f35b5e5762251f53de767250d28">sigaddset</a>(&amp;mask,signum);
<a name="l01337"></a>01337     <a class="code" href="kernel_8h.html#a77f9091c0d09a555bfe33794fa338b59">kMaskSignal</a>(<a class="code" href="signal_8h.html#a927f6ae16379576d638006c7498ac5d7">SIG_BLOCK</a>,&amp;mask,&amp;sa-&gt;<a class="code" href="structsigaction.html#a684e70081d03d46ce70af097ea5cfd49">sa_mask</a>);
<a name="l01338"></a>01338 
<a name="l01339"></a>01339     <span class="comment">// remove trigger flag</span>
<a name="l01340"></a>01340     <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a93a4e339ba91ac50569513595414c518">sig_triggered</a>[signum]=0;
<a name="l01341"></a>01341 
<a name="l01342"></a>01342     <span class="comment">// reset handler when needed    </span>
<a name="l01343"></a>01343     <span class="keyword">struct </span><a class="code" href="structsigaction.html">sigaction</a> *s=&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ad8975ee0bd89cfb79575243bc969ad97">sig_action</a>[signum];
<a name="l01344"></a>01344     <span class="keywordflow">if</span>(s-&gt;<a class="code" href="structsigaction.html#aea0dabe7a03641c8b426521f4406b425">sa_flags</a>&amp;<a class="code" href="signal_8h.html#a8d5fb4f35858d31035e7354c1d4048ea">SA_RESETHAND</a>){
<a name="l01345"></a>01345         s-&gt;<a class="code" href="structsigaction.html#a0087bff9c76e53abfe8b2a527add0241">sa_handler</a>=<a class="code" href="signal_8h.html#a4b51103b50bee4194639fe0572ced56e">_sig_def_func</a>[signum];
<a name="l01346"></a>01346         s-&gt;<a class="code" href="structsigaction.html#aea0dabe7a03641c8b426521f4406b425">sa_flags</a>&amp;=~<a class="code" href="signal_8h.html#a8d5fb4f35858d31035e7354c1d4048ea">SA_RESETHAND</a>;
<a name="l01347"></a>01347         <a class="code" href="signal_8h.html#aa5c62f35b5e5762251f53de767250d28">sigaddset</a>(&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#afd1a791b1121f56048cf36af83cd9dc7">sig_enabled</a>,signum);
<a name="l01348"></a>01348     }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01351"></a>01351 <span class="preprocessor">#else</span>
<a name="l01352"></a>01352 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ENOSYS;
<a name="l01353"></a>01353 <span class="preprocessor">#endif</span>
<a name="l01354"></a>01354 <span class="preprocessor"></span>}
<a name="l01355"></a>01355 <span class="comment"></span>
<a name="l01356"></a>01356 <span class="comment">/*!</span>
<a name="l01357"></a>01357 <span class="comment"> * \brief Send signal to other process.</span>
<a name="l01358"></a>01358 <span class="comment"> * \details A signal will only be triggered (and thus handled) once.</span>
<a name="l01359"></a>01359 <span class="comment"> * \details When the signal was already triggered, the previous sv will be overwritten.</span>
<a name="l01360"></a>01360 <span class="comment"> * \param pid the process to send to</span>
<a name="l01361"></a>01361 <span class="comment"> * \param sig the signal number to send</span>
<a name="l01362"></a>01362 <span class="comment"> * \param sv value to pass to the handler by siginfo_t</span>
<a name="l01363"></a>01363 <span class="comment"> * \return ESRCH when the process does not exist (anymore), ENOENT when the signal was disabled, EAGAIN when masked, 0 on accept, otherwise another errno</span>
<a name="l01364"></a>01364 <span class="comment"> */</span>
<a name="l01365"></a><a class="code" href="kernel_8cc.html#a3d153b50a65f33fd6307427861e74d88">01365</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#af8a4ca7aa349cf79f0302c82aa940d42" title="Send signal to other process.">kSendSignal</a>(pid_t pid,<span class="keywordtype">int</span> sig,<span class="keyword">union</span> <a class="code" href="unionsigval.html">sigval</a>* <a class="code" href="structsigaction.html#ad83b9c01ec7ce76e0803d322acdef9e4">sv</a>){
<a name="l01366"></a>01366 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01367"></a>01367 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01368"></a>01368         <span class="keywordflow">return</span> ESRCH;
<a name="l01369"></a>01369     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01370"></a>01370 
<a name="l01371"></a>01371     <span class="keywordflow">switch</span>(proc-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>){
<a name="l01372"></a>01372     <span class="keywordflow">case</span> <a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>:
<a name="l01373"></a>01373     <span class="keywordflow">case</span> <a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1c2114335a42993ac5cc5dbf65f83d41" title="process waits for signal">SUSPENDED</a>:
<a name="l01374"></a>01374         <span class="keywordflow">break</span>;
<a name="l01375"></a>01375     <span class="keywordflow">default</span>:
<a name="l01376"></a>01376         <span class="keywordflow">return</span> ESRCH;
<a name="l01377"></a>01377     }
<a name="l01378"></a>01378     <span class="keywordflow">if</span>(sig&lt;=0||sig&gt;=<a class="code" href="signal_8h.html#ab83b88daaecc469d1edb90a527ab4a39">NSIG</a>)
<a name="l01379"></a>01379         <span class="keywordflow">return</span> EINVAL;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381     <span class="comment">// make sure a yield will have effect</span>
<a name="l01382"></a>01382     sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384     <span class="comment">// always set sticky signal, even when masked/disabled</span>
<a name="l01385"></a>01385     <span class="keywordflow">if</span>(<a class="code" href="signal_8h.html#a9e84054b8a06c04ed727ce385caa94aa">SIG_STICKY</a>&amp;(1&lt;&lt;sig))
<a name="l01386"></a>01386         <span class="comment">// flag this sticky signal</span>
<a name="l01387"></a>01387         <a class="code" href="device_8h.html#a27f2c6515d0c582c428e6d47d67d1c92">laset</a>((<span class="keywordtype">int</span>*)&amp;proc-&gt;<a class="code" href="struct__proc__table__t.html#acc13ca1a2f2a47b66dececa119dd6cff">sig_sticky</a>,1&lt;&lt;sig);
<a name="l01388"></a>01388     
<a name="l01389"></a>01389     <span class="keywordflow">if</span>(!<a class="code" href="signal_8h.html#af35fa9b288e1eb0862c7bd0346f0600f">sigismember</a>(&amp;proc-&gt;<a class="code" href="struct__proc__table__t.html#afd1a791b1121f56048cf36af83cd9dc7">sig_enabled</a>,sig))
<a name="l01390"></a>01390         <span class="keywordflow">return</span> ENOENT;
<a name="l01391"></a>01391 
<a name="l01392"></a>01392     <span class="comment">// check mask</span>
<a name="l01393"></a>01393     <span class="keywordflow">if</span>(<a class="code" href="signal_8h.html#af35fa9b288e1eb0862c7bd0346f0600f">sigismember</a>(&amp;proc-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>,sig))
<a name="l01394"></a>01394         <span class="keywordflow">return</span> EAGAIN;
<a name="l01395"></a>01395     
<a name="l01396"></a>01396     <span class="comment">// register signal</span>
<a name="l01397"></a>01397 <span class="comment">//  DEBUG(&quot;sig %d from %d to %d&quot;,sig,kGetPid(),pid);</span>
<a name="l01398"></a>01398     <span class="keywordflow">if</span>(sv)
<a name="l01399"></a>01399         proc-&gt;<a class="code" href="struct__proc__table__t.html#ad8975ee0bd89cfb79575243bc969ad97">sig_action</a>[sig].<a class="code" href="structsigaction.html#ad83b9c01ec7ce76e0803d322acdef9e4">sv</a>=*<a class="code" href="structsigaction.html#ad83b9c01ec7ce76e0803d322acdef9e4">sv</a>;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     <span class="keywordflow">switch</span>(sig){
<a name="l01402"></a>01402     <span class="keywordflow">case</span> <a class="code" href="signal_8h.html#a024f43063003e753afc6cca1acd6e104">SIGCONT</a>:
<a name="l01403"></a>01403         proc-&gt;<a class="code" href="struct__proc__table__t.html#a0059c2718d91394d1f1e944f639d730d">sig_trig_handling</a>[<a class="code" href="kernel_8h.html#add9a877f74cf3256fc7158a626d5a65f">SIG_TRIG_HANDLING_CONT</a>]=1;
<a name="l01404"></a>01404         <span class="keywordflow">break</span>;
<a name="l01405"></a>01405     <span class="keywordflow">default</span>:
<a name="l01406"></a>01406         proc-&gt;<a class="code" href="struct__proc__table__t.html#a93a4e339ba91ac50569513595414c518">sig_triggered</a>[sig]=1;
<a name="l01407"></a>01407         barrier();
<a name="l01408"></a>01408         proc-&gt;<a class="code" href="struct__proc__table__t.html#a0059c2718d91394d1f1e944f639d730d">sig_trig_handling</a>[<a class="code" href="kernel_8h.html#a208f767e10ee22c578178eec1e7214e6">SIG_TRIG_HANDLING_SEND</a>]=1;
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01411"></a>01411 <span class="preprocessor">#else</span>
<a name="l01412"></a>01412 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ENOSYS;
<a name="l01413"></a>01413 <span class="preprocessor">#endif</span>
<a name="l01414"></a>01414 <span class="preprocessor"></span>}
<a name="l01415"></a>01415 
<a name="l01416"></a><a class="code" href="kernel_8cc.html#abe73a763cb52339e69b69097e01118a7">01416</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a77f9091c0d09a555bfe33794fa338b59">kMaskSignal</a>(<span class="keywordtype">int</span> how, <span class="keyword">const</span> <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a>* <span class="keyword">set</span>, <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a>* oldset){
<a name="l01417"></a>01417 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01418"></a>01418 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(!<span class="keyword">set</span>)
<a name="l01419"></a>01419         <span class="keywordflow">return</span> EINVAL;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421     <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a> old=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>;
<a name="l01422"></a>01422     <a class="code" href="signal_8h.html#a2ff4a1e7ebbf06b18271000ab5d1f095">sigset_t</a> newset=(*set)&amp;<a class="code" href="signal_8h.html#aac0cc674291a5cb69aad1d1783e41445">SIG_BLOCKABLE</a>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424     <span class="keywordflow">switch</span>(how){
<a name="l01425"></a>01425     <span class="keywordflow">case</span> <a class="code" href="signal_8h.html#a927f6ae16379576d638006c7498ac5d7">SIG_BLOCK</a>:
<a name="l01426"></a>01426         <a class="code" href="signal_8h.html#a899937e191450aaea9efdcf786b65f48">sigorset</a>(&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>,&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>,&amp;newset);
<a name="l01427"></a>01427         <span class="keywordflow">break</span>;
<a name="l01428"></a>01428     <span class="keywordflow">case</span> <a class="code" href="signal_8h.html#a5fcd73313a63dac2cc7eb3b654215250">SIG_UNBLOCK</a>:
<a name="l01429"></a>01429         newset=~newset;
<a name="l01430"></a>01430         <a class="code" href="signal_8h.html#a113f7fc3f57730e99a6f629fccc5f7b1">sigandset</a>(&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>,&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>,&amp;newset);
<a name="l01431"></a>01431         <span class="keywordflow">break</span>;
<a name="l01432"></a>01432     <span class="keywordflow">case</span> <a class="code" href="signal_8h.html#a37750b78b7ae75fe02ad26e70f6cc845">SIG_SETMASK</a>:
<a name="l01433"></a>01433         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a162245b265000f27788a0abcbeb9ee5f">sig_mask</a>=newset;
<a name="l01434"></a>01434         <span class="keywordflow">break</span>;
<a name="l01435"></a>01435     <span class="keywordflow">default</span>:
<a name="l01436"></a>01436         <span class="keywordflow">return</span> EINVAL;
<a name="l01437"></a>01437     }
<a name="l01438"></a>01438     
<a name="l01439"></a>01439     <span class="keywordflow">if</span>(oldset)
<a name="l01440"></a>01440         *oldset=old;
<a name="l01441"></a>01441 
<a name="l01442"></a>01442     <span class="keywordflow">return</span> <a class="code" href="api_8h.html#a54c5298a76b9c539d23fd647b1df996d">ESUCCESS</a>;
<a name="l01443"></a>01443 <span class="preprocessor">#else</span>
<a name="l01444"></a>01444 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ENOSYS;
<a name="l01445"></a>01445 <span class="preprocessor">#endif</span>
<a name="l01446"></a>01446 <span class="preprocessor"></span>}
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 <span class="preprocessor">#ifdef KERNEL_SYNC_EVENTS</span>
<a name="l01449"></a><a class="code" href="kernel_8cc.html#ae5dfcd55ef79bb8e64c97d366bc6a94c">01449</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="structsync__event__entry__t.html">sync_event_entry_t</a>* <a class="code" href="kernel_8cc.html#ae5dfcd55ef79bb8e64c97d366bc6a94c">kFindEventEntry</a>(<a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc,<span class="keywordtype">void</span>* event){
<a name="l01450"></a>01450 retry:
<a name="l01451"></a>01451     <a class="code" href="structsync__event__entry__t.html">sync_event_entry_t</a> *se=&amp;proc-&gt;<a class="code" href="struct__proc__table__t.html#a9abba6da276237ab98dd8f0dd76a8b1a">sync_event</a>[0],*firstempty=NULL;
<a name="l01452"></a>01452     <span class="keywordtype">int</span> i;
<a name="l01453"></a>01453     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="helix__config_8h.html#afc3ed9192ffe6b7beb47b1bf056e6de0" title="Number of sync event records per process.">KERNEL_SYNC_EVENTS</a>;i++,se++){
<a name="l01454"></a>01454         <span class="keywordflow">if</span>(se-&gt;<a class="code" href="structsync__event__entry__t.html#ac6ff3a88c09fce4cda56d2388889c16b">event</a>==event)
<a name="l01455"></a>01455             <span class="keywordflow">goto</span> found;
<a name="l01456"></a>01456         <span class="keywordflow">if</span>(!firstempty&amp;&amp;se-&gt;<a class="code" href="structsync__event__entry__t.html#ac6ff3a88c09fce4cda56d2388889c16b">event</a>==NULL)
<a name="l01457"></a>01457             firstempty=se;
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459     <span class="comment">// no record found, have empty record?</span>
<a name="l01460"></a>01460     <span class="keywordflow">if</span>(!firstempty)
<a name="l01461"></a>01461         <span class="keywordflow">return</span> NULL;
<a name="l01462"></a>01462     <span class="comment">// try to use this record</span>
<a name="l01463"></a>01463     se=firstempty;
<a name="l01464"></a>01464     <span class="keywordflow">if</span>(lcas((<span class="keywordtype">int</span>*)(<span class="keywordtype">void</span>*)&amp;se-&gt;<a class="code" href="structsync__event__entry__t.html#ac6ff3a88c09fce4cda56d2388889c16b">event</a>,0,(<span class="keywordtype">int</span>)event)!=0)
<a name="l01465"></a>01465         <span class="comment">// just changed record</span>
<a name="l01466"></a>01466         <span class="keywordflow">goto</span> retry;
<a name="l01467"></a>01467     <span class="comment">// no need to reset other fields</span>
<a name="l01468"></a>01468     <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>==se-&gt;<a class="code" href="structsync__event__entry__t.html#a9133e4713c6e15bbae8b9098544707c8">wait</a>,<span class="stringliteral">&quot;Sync event record invalid: %d != %d&quot;</span>,se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>,se-&gt;<a class="code" href="structsync__event__entry__t.html#a9133e4713c6e15bbae8b9098544707c8">wait</a>);
<a name="l01469"></a>01469     <span class="comment">// ok, got record</span>
<a name="l01470"></a>01470 found:
<a name="l01471"></a>01471     <span class="keywordflow">return</span> se;
<a name="l01472"></a>01472 }
<a name="l01473"></a>01473 <span class="preprocessor">#endif</span>
<a name="l01474"></a>01474 <span class="preprocessor"></span><span class="comment"></span>
<a name="l01475"></a>01475 <span class="comment">/*!</span>
<a name="l01476"></a>01476 <span class="comment"> * \brief Marks specified event as hit.</span>
<a name="l01477"></a>01477 <span class="comment"> * \details Increments hit counter corresponding to specified event.</span>
<a name="l01478"></a>01478 <span class="comment"> * \details Should only be called from the task daemon.</span>
<a name="l01479"></a>01479 <span class="comment"> * \param pid the process to sent the hit to</span>
<a name="l01480"></a>01480 <span class="comment"> * \param event the event that has been hit</span>
<a name="l01481"></a>01481 <span class="comment"> * \returns ENOMEM when out of event records, 0 on success, otherwise an errno</span>
<a name="l01482"></a>01482 <span class="comment"> */</span>
<a name="l01483"></a><a class="code" href="kernel_8cc.html#a4a0a27df3e770e1c8888fae620cf0087">01483</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#a6d0c38820dea429312d14fdbcd45cf43" title="Marks specified event as hit.">kSyncEventHit</a>(pid_t pid,<span class="keywordtype">void</span>* event){
<a name="l01484"></a>01484 <span class="preprocessor">#ifdef KERNEL_SYNC_EVENTS</span>
<a name="l01485"></a>01485 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>()!=0)
<a name="l01486"></a>01486         <span class="keywordflow">return</span> EPERM;
<a name="l01487"></a>01487     <span class="keywordflow">if</span>(pid&lt;0||pid&gt;=<a class="code" href="helix__config_8h.html#a92fd8bb5807bf6abb640686f51e5df3e" title="Maximum number of running processes per kernel.">MAX_PROCESSES</a>)
<a name="l01488"></a>01488         <span class="keywordflow">return</span> ESRCH;
<a name="l01489"></a>01489     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* proc=&amp;<a class="code" href="kernel_8h.html#a7b21412447a44f3594e1eac57cda11c3" title="pointer to our kernel_context, equals kernel_contexts[GetProcID()]">kernel_context</a>-&gt;<a class="code" href="structkernel__context__t.html#ac0e983260192dd33fd0f38916ee354ef" title="the process table with all processes">proc_table</a>[<a class="code" href="trace_8cc.html#ae0d46a978d5cd6707411f276ad869b9c">pid</a>];
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <span class="keywordflow">switch</span>(proc-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>){
<a name="l01492"></a>01492     <span class="keywordflow">case</span> <a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>:
<a name="l01493"></a>01493 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01494"></a>01494 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1c2114335a42993ac5cc5dbf65f83d41" title="process waits for signal">SUSPENDED</a>:
<a name="l01495"></a>01495 <span class="preprocessor">#endif</span>
<a name="l01496"></a>01496 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
<a name="l01497"></a>01497     <span class="keywordflow">default</span>:
<a name="l01498"></a>01498         <span class="keywordflow">return</span> ESRCH;
<a name="l01499"></a>01499     }
<a name="l01500"></a>01500     <span class="keywordflow">if</span>(event==NULL)
<a name="l01501"></a>01501         <span class="keywordflow">return</span> EINVAL;
<a name="l01502"></a>01502     
<a name="l01503"></a>01503 retry:
<a name="l01504"></a>01504     <a class="code" href="structsync__event__entry__t.html">sync_event_entry_t</a>* se=<a class="code" href="kernel_8cc.html#ae5dfcd55ef79bb8e64c97d366bc6a94c">kFindEventEntry</a>(proc,event);
<a name="l01505"></a>01505     <span class="keywordflow">if</span>(!se)
<a name="l01506"></a>01506         <span class="keywordflow">return</span> ENOMEM;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     <span class="keywordflow">if</span>(lcondset((<span class="keywordtype">int</span>*)(<span class="keywordtype">void</span>*)&amp;se-&gt;<a class="code" href="structsync__event__entry__t.html#ac6ff3a88c09fce4cda56d2388889c16b">event</a>,(<span class="keywordtype">int</span>)event,(<span class="keywordtype">int</span>*)&amp;se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>,se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>+1,se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>)!=(<span class="keywordtype">int</span>)event)
<a name="l01509"></a>01509         <span class="keywordflow">goto</span> retry;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511 <span class="comment">//  DEBUG(&quot;Hit %p=%d -&gt; %d (entry: %p)&quot;,event,se-&gt;hit,pid,se);</span>
<a name="l01512"></a>01512     <span class="keywordflow">return</span> 0;
<a name="l01513"></a>01513 <span class="preprocessor">#else</span>
<a name="l01514"></a>01514 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ENOSYS;
<a name="l01515"></a>01515 <span class="preprocessor">#endif</span>
<a name="l01516"></a>01516 <span class="preprocessor"></span>}
<a name="l01517"></a>01517 <span class="comment"></span>
<a name="l01518"></a>01518 <span class="comment">/*!</span>
<a name="l01519"></a>01519 <span class="comment"> * \brief Blocks until a given event has occured.</span>
<a name="l01520"></a>01520 <span class="comment"> * \param event the event to wait for</span>
<a name="l01521"></a>01521 <span class="comment"> * \param count the number of hits to wait for</span>
<a name="l01522"></a>01522 <span class="comment"> * \returns ENOMEM when out of empty event records, 0 on success, otherwise an errno</span>
<a name="l01523"></a>01523 <span class="comment"> */</span>
<a name="l01524"></a><a class="code" href="kernel_8cc.html#a9311ebfad1bae5efed571b7103e33df4">01524</a> <span class="keywordtype">int</span> <a class="code" href="kernel_8h.html#ade9a63180e07f92038f34dcc8ebda60a" title="Blocks until a given event has occured.">kSyncEventWait</a>(<span class="keywordtype">void</span>* event,<span class="keywordtype">int</span> count){
<a name="l01525"></a>01525 <span class="preprocessor">#ifdef KERNEL_SYNC_EVENTS</span>
<a name="l01526"></a>01526 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(event==NULL||count&lt;1)
<a name="l01527"></a>01527         <span class="keywordflow">return</span> EINVAL;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529     <a class="code" href="structsync__event__entry__t.html">sync_event_entry_t</a>* se=<a class="code" href="kernel_8cc.html#ae5dfcd55ef79bb8e64c97d366bc6a94c">kFindEventEntry</a>(<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>,event);
<a name="l01530"></a>01530     <span class="keywordflow">if</span>(!se)
<a name="l01531"></a>01531         <span class="keywordflow">return</span> ENOMEM;
<a name="l01532"></a>01532 <span class="comment">//  DEBUG(&quot;Wait %p (entry: %p, pid=%d)&quot;,event,se,kGetPid());</span>
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     <span class="keywordflow">for</span>(;count&gt;0;count--){
<a name="l01535"></a>01535         <span class="keywordflow">while</span>(se-&gt;<a class="code" href="structsync__event__entry__t.html#a9133e4713c6e15bbae8b9098544707c8">wait</a>==se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>)
<a name="l01536"></a>01536             <span class="comment">// light weight, fast responding; don&#39;t suspend, just yield</span>
<a name="l01537"></a>01537             <a class="code" href="kernel_8h.html#ab91f44b41a9180f07267ac1ead6dfdbd" title="Forcably ends the timeslice of the current process.">kYield</a>(<span class="keyword">false</span>);
<a name="l01538"></a>01538         <span class="comment">// got event</span>
<a name="l01539"></a>01539         se-&gt;<a class="code" href="structsync__event__entry__t.html#a9133e4713c6e15bbae8b9098544707c8">wait</a>++;
<a name="l01540"></a>01540     }
<a name="l01541"></a>01541     <span class="comment">// clean record when unused</span>
<a name="l01542"></a>01542     lcondset((<span class="keywordtype">int</span>*)&amp;se-&gt;<a class="code" href="structsync__event__entry__t.html#a9133e4713c6e15bbae8b9098544707c8">wait</a>,se-&gt;<a class="code" href="structsync__event__entry__t.html#a464e1e9a0aff8186e22a6c912c62a1be">hit</a>,(<span class="keywordtype">int</span>*)(<span class="keywordtype">void</span>*)&amp;se-&gt;<a class="code" href="structsync__event__entry__t.html#ac6ff3a88c09fce4cda56d2388889c16b">event</a>,0,(<span class="keywordtype">int</span>)event);
<a name="l01543"></a>01543     <span class="comment">// got all requested events</span>
<a name="l01544"></a>01544     <span class="keywordflow">return</span> 0;
<a name="l01545"></a>01545 <span class="preprocessor">#else</span>
<a name="l01546"></a>01546 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ENOSYS;
<a name="l01547"></a>01547 <span class="preprocessor">#endif</span>
<a name="l01548"></a>01548 <span class="preprocessor"></span>}
<a name="l01549"></a>01549 <span class="comment"></span>
<a name="l01550"></a>01550 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l01551"></a>01551 <span class="comment"></span><span class="comment">// Scheduling</span><span class="comment"></span>
<a name="l01552"></a>01552 <span class="comment">//////////////////////////////////////////////////////</span>
<a name="l01553"></a>01553 <span class="comment"></span>
<a name="l01554"></a>01554 <span class="preprocessor">#undef TRACE</span>
<a name="l01555"></a><a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">01555</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE ((trace_t*)kernel_context-&gt;hooks[HOOK_TRACE])</span>
<a name="l01556"></a>01556 <span class="preprocessor"></span><span class="comment"></span>
<a name="l01557"></a>01557 <span class="comment">/*!</span>
<a name="l01558"></a>01558 <span class="comment"> * \brief Initializes the scheduler and start scheduling.</span>
<a name="l01559"></a>01559 <span class="comment"> * \details Never returns.</span>
<a name="l01560"></a>01560 <span class="comment"> */</span>
<a name="l01561"></a><a class="code" href="kernel_8cc.html#a6e5acd9d66f11151cbc5a843583cf9e7">01561</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a6e5acd9d66f11151cbc5a843583cf9e7" title="Initializes the scheduler and start scheduling.">kStartScheduling</a>(){
<a name="l01562"></a>01562     <a class="code" href="kernel_8cc.html#abf55d0a7851b10bdb091a9bef8dac51e">DEBUG0</a>(<span class="stringliteral">&quot;Initializing scheduler...&quot;</span>);
<a name="l01563"></a>01563     sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l01564"></a>01564     sch.<a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">have_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l01565"></a>01565     sch.<a class="code" href="structsch__t.html#a7aaeb6527aafa2fa7a2f0755164dfb61">was_idle</a>=0;
<a name="l01566"></a>01566     <a class="code" href="kernel_8cc.html#a017d3e8af0a7f0e5266f61ac26fadd66">kSetOSState</a>(<a class="code" href="kernel_8h.html#a377ea6c9edb9a0cb4c553bd158580fbeac5768f7263a08b7583de3052962d5f0c">OS_MULTI</a>);
<a name="l01567"></a>01567     <a class="code" href="io_8h.html#a2ee7bc790264da3d5ce3a3d2b55d545d">kInitIrq</a>();
<a name="l01568"></a>01568     <span class="comment">// context switches are triggered when an interrupt occures, so trigger one</span>
<a name="l01569"></a>01569 <span class="preprocessor">#ifndef SCHEDULE_SLOTS</span>
<a name="l01570"></a>01570 <span class="preprocessor"></span>    <span class="comment">// somehow the MicroBlaze misses sometimes the first interrupt, so repeat this one to make sure...</span>
<a name="l01571"></a>01571     <a class="code" href="io_8h.html#addab75fc1cac75af9faa313752db39bc" title="Sets the local timer to the designated number of clock cycles.">kSetTimer</a>(100000,100000);
<a name="l01572"></a>01572 <span class="preprocessor">#else</span>
<a name="l01573"></a>01573 <span class="preprocessor"></span>    sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>=1;
<a name="l01574"></a>01574     sch.<a class="code" href="structsch__t.html#ad37f09582d4fc75ff893686de8816a2a">skip_taskdaemon</a>=1;
<a name="l01575"></a>01575     <a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>-&gt;prev_entry=NULL;
<a name="l01576"></a>01576     <a class="code" href="io_8h.html#addab75fc1cac75af9faa313752db39bc" title="Sets the local timer to the designated number of clock cycles.">kSetTimer</a>(<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>,<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>);
<a name="l01577"></a>01577 <span class="preprocessor">#endif</span>
<a name="l01578"></a>01578 <span class="preprocessor"></span>    barrier();
<a name="l01579"></a>01579     <a class="code" href="kernel_8h.html#a39515156d59fe71794032535eb367786" title="Enables interrupts in the processor.">kEnableInterrupt</a>();
<a name="l01580"></a>01580     <span class="keywordflow">while</span>(<span class="keyword">true</span>);
<a name="l01581"></a>01581 }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583 <span class="preprocessor">#undef ASSERT</span>
<a name="l01584"></a><a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">01584</a> <span class="preprocessor"></span><span class="preprocessor">#define ASSERT(expr,msg)        do{if(unlikely(!(expr)))kPanic(msg);}while(0)</span>
<a name="l01585"></a>01585 <span class="preprocessor"></span>
<a name="l01586"></a>01586 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01587"></a>01587 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#ae44c134486402440002d11a9ba8304af">kCheckFreeStack</a>() __attribute__((unused));
<a name="l01588"></a><a class="code" href="kernel_8cc.html#ae44c134486402440002d11a9ba8304af">01588</a> static <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#ae44c134486402440002d11a9ba8304af">kCheckFreeStack</a>(){
<a name="l01589"></a>01589     <span class="comment">// -1 means that the signal context has been reset</span>
<a name="l01590"></a>01590     <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>((<span class="keywordtype">int</span>)<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[1]!=-1)){
<a name="l01591"></a>01591         <span class="keywordtype">int</span> free_stack=(int)<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[1]-(<span class="keywordtype">int</span>)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af75ad68d0a83c9a5f0814478e2553c67" title="stack of this process, malloced in processor heap">stack</a>;
<a name="l01592"></a>01592         <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(free_stack&lt;current_proc-&gt;min_stack&amp;&amp;free_stack&gt;=0))
<a name="l01593"></a>01593             <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a43ad7b82f9c1ec3635f6e7c0a1d6396f" title="maximum stack use">min_stack</a>=free_stack;
<a name="l01594"></a>01594     }
<a name="l01595"></a>01595     <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ac74c6973267778662c83dfadc1816577" title="number of context switches">context_switches</a>++;
<a name="l01596"></a>01596 }
<a name="l01597"></a>01597 <span class="preprocessor">#else</span>
<a name="l01598"></a>01598 <span class="preprocessor"></span><span class="preprocessor">#define kCheckFreeStack(...)</span>
<a name="l01599"></a>01599 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01600"></a>01600 <span class="preprocessor"></span>
<a name="l01601"></a>01601 <span class="preprocessor">#ifdef KERNEL_DEBUG</span>
<a name="l01602"></a>01602 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#aab817c9b0bf11c52dfaf813910e31720">kCheckStackOverflow</a>() __attribute__((unused));
<a name="l01603"></a><a class="code" href="kernel_8cc.html#aab817c9b0bf11c52dfaf813910e31720">01603</a> static <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#aab817c9b0bf11c52dfaf813910e31720">kCheckStackOverflow</a>(){
<a name="l01604"></a>01604     <a class="code" href="kernel_8h.html#a69471a3ff8b448af4172f71d74bed723" title="thread-local reentrancy struct of newlib, must point to process&#39;s proc_table_t::impure_data">_impure_ptr</a>=<a class="code" href="kernel_8cc.html#aea5a41e11c90591e0e82309d15680c19" title="Pointer to global_impure_data.">_kernel_impure_ptr</a>;
<a name="l01605"></a>01605     <span class="comment">// Checking for stack overflows is not very reliable. When the stack has shrunk before</span>
<a name="l01606"></a>01606     <span class="comment">// the context switch, it won&#39;t be detected. Also, when a stack overflow occurs, it is already</span>
<a name="l01607"></a>01607     <span class="comment">// too late. Better is to give every process its own page using the MMU and trap when it accesses</span>
<a name="l01608"></a>01608     <span class="comment">// memory outside that page.</span>
<a name="l01609"></a>01609     <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>-&gt;<a class="code" href="structproc__context__t.html#adfd579965d4fcc1d649d0ccafd716c79" title="all registers of the cpu during a context switch, PC is stored in r14, SP in r1">regs</a>[1]&lt;(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af75ad68d0a83c9a5f0814478e2553c67" title="stack of this process, malloced in processor heap">stack</a>)){
<a name="l01610"></a>01610         <span class="comment">// not very elegant, but very handy, since printf() doesn&#39;t work anymore at this point</span>
<a name="l01611"></a>01611         <span class="keywordtype">char</span> msg[]=<span class="stringliteral">&quot;Process&#39;s ? stack overflow detected. Heap datastructures destroyed.&quot;</span>;
<a name="l01612"></a>01612         msg[10]=<span class="charliteral">&#39;0&#39;</span>+<a class="code" href="kernel_8h.html#a070c51905ae8ad68e2bdb51875bb6468" title="Returns the process id of the current process.">kGetPid</a>();
<a name="l01613"></a>01613         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(msg);
<a name="l01614"></a>01614     }
<a name="l01615"></a>01615     <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(*(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>*)<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af75ad68d0a83c9a5f0814478e2553c67" title="stack of this process, malloced in processor heap">stack</a>!=<a class="code" href="kernel_8cc.html#adb8d91529f94de9573a88c3b8514ac6f">STACK_PROTECTION_VALUE</a>))
<a name="l01616"></a>01616         <a class="code" href="kernel_8h.html#a046abae034ad18c182a01a5cc466b882" title="Prints coredump and halts kernel, in case of emergency.">kPanic</a>(<span class="stringliteral">&quot;Possible stack overflow detected. Heap integrity compromised.&quot;</span>);
<a name="l01617"></a>01617 }
<a name="l01618"></a>01618 <span class="preprocessor">#else</span>
<a name="l01619"></a>01619 <span class="preprocessor"></span><span class="preprocessor">#define kCheckStackOverflow(...)</span>
<a name="l01620"></a>01620 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01621"></a>01621 <span class="preprocessor"></span>
<a name="l01622"></a><a class="code" href="kernel_8cc.html#a0f8a6392225c4e8fe2d9e6a6eee7811d">01622</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="kernel_8cc.html#a0f8a6392225c4e8fe2d9e6a6eee7811d">kScheduleProcess</a>(<a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* next, <span class="keywordtype">bool</span> continue_slice){
<a name="l01623"></a>01623     <span class="comment">// acknowledge receiving the interrupt</span>
<a name="l01624"></a>01624     <a class="code" href="io_8h.html#a0352bf4a04538b99075ae5970d7aca98">kClearIrq</a>();
<a name="l01625"></a>01625     <span class="comment">// we have the next process to context switch to, choose between signal handler and main process</span>
<a name="l01626"></a>01626     <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>,next);
<a name="l01627"></a>01627 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01628"></a>01628 <span class="preprocessor"></span>    next-&gt;<a class="code" href="struct__proc__table__t.html#a3cb567e32691a0c4a3d6d33d21fa95c2">sig_ret</a>=0;
<a name="l01629"></a>01629     next-&gt;<a class="code" href="struct__proc__table__t.html#a0059c2718d91394d1f1e944f639d730d">sig_trig_handling</a>[<a class="code" href="kernel_8h.html#add9a877f74cf3256fc7158a626d5a65f">SIG_TRIG_HANDLING_CONT</a>]=0;
<a name="l01630"></a>01630     <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(next-&gt;<a class="code" href="struct__proc__table__t.html#acce8465a85099ffe0aa4fa8adf4117d8">sig_havetriggered</a>&amp;&amp;!next-&gt;<a class="code" href="struct__proc__table__t.html#a0059c2718d91394d1f1e944f639d730d">sig_trig_handling</a>[<a class="code" href="kernel_8h.html#aacd59d809c1d749e3b7bda4b93881ea8">SIG_TRIG_HANDLING_ABRT</a>])){ 
<a name="l01631"></a>01631         <span class="comment">// sig_trig_handling[SIG_TRIG_HANDLING_ABRT] is set in exit_from_sigh to indicate that we have to return to</span>
<a name="l01632"></a>01632         <span class="comment">// the normal process immediately, because the process is aborted.</span>
<a name="l01633"></a>01633         <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>,&amp;next-&gt;<a class="code" href="struct__proc__table__t.html#a19e3d2baf45acac9c356c2f0e1d85b1a">sig_context</a>);
<a name="l01634"></a>01634         <span class="keywordflow">if</span>(!next-&gt;<a class="code" href="struct__proc__table__t.html#a0059c2718d91394d1f1e944f639d730d">sig_trig_handling</a>[<a class="code" href="kernel_8h.html#a8d3fac31134d615d90d713ae46a930d5">SIG_TRIG_HANDLING_HAND</a>])
<a name="l01635"></a>01635             <span class="comment">// new invocation of signal handler, force to start of handler</span>
<a name="l01636"></a>01636             <a class="code" href="kernel_8cc.html#a623caf4cba9f8fe345d3412fe457908a">kResetSignalContext</a>(&amp;next-&gt;<a class="code" href="struct__proc__table__t.html#a19e3d2baf45acac9c356c2f0e1d85b1a">sig_context</a>);
<a name="l01637"></a>01637     }<span class="keywordflow">else</span>
<a name="l01638"></a>01638 <span class="preprocessor">#endif</span>
<a name="l01639"></a>01639 <span class="preprocessor"></span>        <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<a class="code" href="structproc__context__t.html" title="The context of a process.">proc_context_t</a>,<a class="code" href="kernel_8h.html#a5517ad3b74016925c521c71812d11aea" title="location to store context of currently running process">current_context</a>,&amp;next-&gt;<a class="code" href="struct__proc__table__t.html#aaa93be5012a07072558257063612c6b5" title="processor context of this process">context</a>);
<a name="l01640"></a>01640     <a class="code" href="kernel_8h.html#a69471a3ff8b448af4172f71d74bed723" title="thread-local reentrancy struct of newlib, must point to process&#39;s proc_table_t::impure_data">_impure_ptr</a>=next-&gt;<a class="code" href="struct__proc__table__t.html#a62e926fa72236941aa253424d3edb6b0" title="reentrancy struct of newlib (_impure_ptr must point to it)">impure_data</a>;
<a name="l01641"></a>01641     <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<span class="keywordtype">void</span>*,<a class="code" href="kernel_8h.html#a4291870e45a9a554746c5d7dc5ba43c2" title="array of thread-local data with size THREAD_LOCAL_FIELDS, initially all set to 0">thread_local</a>,&amp;next-&gt;<a class="code" href="struct__proc__table__t.html#a32f1b12c47aa10f73b3fed4594af9d31">proc_local</a>-&gt;<a class="code" href="structproc__local__t.html#a6e26e169cd93d421722e2cfad2eccde2">user</a>[0]);
<a name="l01642"></a>01642     <a class="code" href="kernel_8cc.html#aa8b6587dc9889f468208812250aaa8a7">ASSIGN_CONST_PTR</a>(<a class="code" href="structproc__local__t.html">proc_local_t</a>,<a class="code" href="kernel_8h.html#a1352c7443011d705fb6866ce18de5766">proc_local</a>,next-&gt;<a class="code" href="struct__proc__table__t.html#a32f1b12c47aa10f73b3fed4594af9d31">proc_local</a>);
<a name="l01643"></a>01643     
<a name="l01644"></a>01644 <span class="preprocessor">#ifdef STACK_CHECK</span>
<a name="l01645"></a>01645 <span class="preprocessor"></span>    _stack_end=(<span class="keywordtype">void</span>*)((<span class="keywordtype">int</span>)next-&gt;<a class="code" href="struct__proc__table__t.html#af75ad68d0a83c9a5f0814478e2553c67" title="stack of this process, malloced in processor heap">stack</a>+STACK_CHECK); <span class="comment">//reserve space for unchecked printf(), etc.</span>
<a name="l01646"></a>01646 <span class="preprocessor">#endif</span>
<a name="l01647"></a>01647 <span class="preprocessor"></span>    
<a name="l01648"></a>01648     sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>=<a class="code" href="kernel_8cc.html#a2c73da0c8100fb61b4e9ed91ec30134d">DID_WORK_MAYBE</a>;
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     <span class="comment">// set time slice</span>
<a name="l01651"></a>01651     <a class="code" href="kernel__types_8h.html#a77e49d03a1e611dab893961ac9886155" title="type of scheduler timer, used internally">timeslice_t</a> <a class="code" href="trace_8cc.html#adc263d460c755651df544db1fded8a4a">timeslice</a>=continue_slice?next-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>:next-&gt;<a class="code" href="struct__proc__table__t.html#aa96b0dad43ede9e43c248df892370e12" title="assigned time slot size">time</a>;
<a name="l01652"></a>01652     
<a name="l01653"></a>01653 <span class="preprocessor">#ifndef SCHEDULE_SLOTS</span>
<a name="l01654"></a>01654 <span class="preprocessor"></span>    <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(timeslice&gt;0,<span class="stringliteral">&quot;Cannot resume passed timeslice&quot;</span>);
<a name="l01655"></a>01655     next-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>=0;
<a name="l01656"></a>01656 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01657"></a>01657 <span class="preprocessor"></span>    next-&gt;<a class="code" href="struct__proc__table__t.html#a60743fea7445a85d6c0184f504ddcf58" title="total time allocated">time_alloc</a>+=<a class="code" href="trace_8cc.html#adc263d460c755651df544db1fded8a4a">timeslice</a>;
<a name="l01658"></a>01658 <span class="preprocessor">#endif</span>
<a name="l01659"></a>01659 <span class="preprocessor"></span>    <a class="code" href="io_8h.html#addab75fc1cac75af9faa313752db39bc" title="Sets the local timer to the designated number of clock cycles.">kSetTimer</a>(timeslice);
<a name="l01660"></a>01660 <span class="preprocessor">#else</span>
<a name="l01661"></a>01661 <span class="preprocessor"></span>    next-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>=timeslice%<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>;
<a name="l01662"></a>01662     sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>=timeslice/<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>;
<a name="l01663"></a>01663     <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>&gt;0,<span class="stringliteral">&quot;Cannot resume passed timeslice&quot;</span>);
<a name="l01664"></a>01664 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01665"></a>01665 <span class="preprocessor"></span>    next-&gt;<a class="code" href="struct__proc__table__t.html#a60743fea7445a85d6c0184f504ddcf58" title="total time allocated">time_alloc</a>+=sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>;
<a name="l01666"></a>01666 <span class="preprocessor">#endif</span>
<a name="l01667"></a>01667 <span class="preprocessor"></span>    <span class="comment">// timer is still running, no need to set</span>
<a name="l01668"></a>01668 <span class="comment">//  kSetTimer(SCHEDULE_SLOTS,SCHEDULE_SLOTS);</span>
<a name="l01669"></a>01669 <span class="preprocessor">#endif</span>
<a name="l01670"></a>01670 <span class="preprocessor"></span>
<a name="l01671"></a>01671     <span class="keywordflow">if</span>(!<a class="code" href="trace_8h.html#a667eebb77d7b92c200c181f97f976c33" title="Put scheduling information in trace.">kTraceSchedule</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>,next-&gt;<a class="code" href="struct__proc__table__t.html#a2a1920067f74dd25917973ce22da4540" title="process ID of this process">pid</a>,continue_slice))
<a name="l01672"></a>01672         <a class="code" href="trace_8h.html#a5e6741882a1fdffb0ab09a2938abf616" title="Closes the trace.">kTraceClose</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>);
<a name="l01673"></a>01673 }
<a name="l01674"></a>01674 <span class="comment"></span>
<a name="l01675"></a>01675 <span class="comment">/*!</span>
<a name="l01676"></a>01676 <span class="comment"> * \brief Determines the next process to schedule.</span>
<a name="l01677"></a>01677 <span class="comment"> * \details This function is called by entry.S after an interrupt.</span>
<a name="l01678"></a>01678 <span class="comment"> */</span>
<a name="l01679"></a><a class="code" href="kernel_8cc.html#ab49fec041d944bc5bb7038104cd65709">01679</a> <span class="keywordtype">void</span> <a class="code" href="kernel_8h.html#a7f4fccda8e6c526f13910352502a4273" title="Determines the next process to schedule.">kScheduleNext</a>(){
<a name="l01680"></a>01680     <a class="code" href="kernel_8cc.html#aafee7403c191c45dd3a07b64954f828a">DEBUG_ON</a>(<a class="code" href="kernel_8cc.html#aa28741aad188fa566e089c3ea540a906">DBLED_SCHEDULE</a>);
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     <a class="code" href="kernel_8cc.html#ae44c134486402440002d11a9ba8304af">kCheckFreeStack</a>();
<a name="l01683"></a>01683     <a class="code" href="kernel_8cc.html#aab817c9b0bf11c52dfaf813910e31720">kCheckStackOverflow</a>();
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     <span class="comment">// determine next process to switch to</span>
<a name="l01686"></a>01686     <a class="code" href="struct__proc__table__t.html" title="The process table.">proc_table_t</a>* next=NULL;
<a name="l01687"></a>01687     <span class="comment">// should we reset the timeslice?</span>
<a name="l01688"></a>01688     <span class="keywordtype">bool</span> continue_slice=<span class="keyword">false</span>;
<a name="l01689"></a>01689     <span class="comment">// did we do some work during last process?</span>
<a name="l01690"></a>01690     <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#a30446f89ecfe879998e2439e4535b7f5">just_did_work</a>!=<a class="code" href="kernel_8cc.html#a6646eba88004157f0b0e52925526488d">DID_WORK_NO</a>)
<a name="l01691"></a>01691         sch.<a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">have_work</a>=<a class="code" href="kernel_8cc.html#a0fe06b0e857323e5b5ff653b84fbb271">DID_WORK_YES</a>;
<a name="l01692"></a>01692 <span class="preprocessor">#ifndef SCHEDULE_SLOTS</span>
<a name="l01693"></a>01693 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>==<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>)
<a name="l01694"></a>01694         <span class="comment">// end of schedule cycle, reset have_work</span>
<a name="l01695"></a>01695         sch.<a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">have_work</a>=<a class="code" href="kernel_8cc.html#a6646eba88004157f0b0e52925526488d">DID_WORK_NO</a>;
<a name="l01696"></a>01696 <span class="preprocessor">#else</span>
<a name="l01697"></a>01697 <span class="preprocessor"></span>    <span class="comment">// are we context switching away from the task daemon?</span>
<a name="l01698"></a>01698     <span class="keyword">const</span> <span class="keywordtype">bool</span> switch_from_taskdaemon=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>==<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>;
<a name="l01699"></a>01699     <span class="comment">// are we context switching away from the task daemon that just interrupted a normal process?</span>
<a name="l01700"></a>01700     <span class="keyword">const</span> <span class="keywordtype">bool</span> switch_from_interrupting_taskdaemon=switch_from_taskdaemon&amp;&amp;<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>!=NULL;
<a name="l01701"></a>01701     <span class="comment">// did we context switch because the task daemon has work to do?</span>
<a name="l01702"></a>01702     <span class="keyword">const</span> <span class="keywordtype">bool</span> switch_to_taskdaemon=sch.<a class="code" href="structsch__t.html#ad37f09582d4fc75ff893686de8816a2a">skip_taskdaemon</a>==0&amp;&amp;*(<span class="keywordtype">int</span>*)FIFO_MEM!=0;
<a name="l01703"></a>01703     
<a name="l01704"></a>01704     <span class="comment">// update timeslice left</span>
<a name="l01705"></a>01705     <span class="keywordflow">if</span>(sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>&gt;0){
<a name="l01706"></a>01706         <span class="comment">// current_proc interrupted (without yield)</span>
<a name="l01707"></a>01707         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>+=sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>*<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>;
<a name="l01708"></a>01708         <span class="keywordflow">if</span>(!<a class="code" href="trace_8h.html#aa5b3169615bc4776bf242339d43867cd" title="Inserts yield in trace.">kTraceScheduleYield</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>,<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>))
<a name="l01709"></a>01709             <a class="code" href="trace_8h.html#a5e6741882a1fdffb0ab09a2938abf616" title="Closes the trace.">kTraceClose</a>(<a class="code" href="kernel_8cc.html#aad9cc64d45a76ba0d37c00f8cd9caa37">TRACE</a>);
<a name="l01710"></a>01710 <span class="preprocessor">#ifdef KERNEL_STATS</span>
<a name="l01711"></a>01711 <span class="preprocessor"></span>        <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#ac9c6ed46b712dd9ad7f53f5c670dc895" title="slack time Yield()ed">slack</a>+=sch.<a class="code" href="structsch__t.html#a7886db301c69bb8cd7ce88abd40b955d">remaining_slots</a>*<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>;
<a name="l01712"></a>01712 <span class="preprocessor">#endif</span>
<a name="l01713"></a>01713 <span class="preprocessor"></span>    }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715     <span class="keywordflow">if</span>(switch_to_taskdaemon){
<a name="l01716"></a>01716         <span class="comment">// interrupt current process and switch to task daemon</span>
<a name="l01717"></a>01717         next=<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>;
<a name="l01718"></a>01718         <span class="comment">// save the process to switch back to</span>
<a name="l01719"></a>01719         next-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>;
<a name="l01720"></a>01720         <span class="comment">// resume timeslice</span>
<a name="l01721"></a>01721         continue_slice=<span class="keyword">true</span>;
<a name="l01722"></a>01722         <span class="keywordflow">goto</span> have_proc;
<a name="l01723"></a>01723     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(switch_from_interrupting_taskdaemon){
<a name="l01724"></a>01724         <span class="comment">// switch back to the process we just interrupted</span>
<a name="l01725"></a>01725         next=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>;
<a name="l01726"></a>01726         <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(next!=<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>,<span class="stringliteral">&quot;Interrupted task daemon&quot;</span>);
<a name="l01727"></a>01727         <span class="keywordflow">if</span>(next-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>&gt;<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a> &amp;&amp; next-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>){
<a name="l01728"></a>01728             <span class="comment">// resume timeslice</span>
<a name="l01729"></a>01729             continue_slice=<span class="keyword">true</span>;
<a name="l01730"></a>01730             <span class="keywordflow">goto</span> have_proc;
<a name="l01731"></a>01731         }<span class="keywordflow">else</span>{
<a name="l01732"></a>01732             <span class="comment">// out of time, do normal scheduling</span>
<a name="l01733"></a>01733             next=next-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>;
<a name="l01734"></a>01734             continue_slice=<span class="keyword">false</span>;
<a name="l01735"></a>01735         }
<a name="l01736"></a>01736     }<span class="keywordflow">else</span>
<a name="l01737"></a>01737 <span class="preprocessor">#endif</span>
<a name="l01738"></a>01738 <span class="preprocessor"></span><span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01739"></a>01739 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="api_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a3cb567e32691a0c4a3d6d33d21fa95c2">sig_ret</a> &amp;&amp; 
<a name="l01740"></a>01740 #ifdef <a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>
<a name="l01741"></a>01741         <span class="comment">// in kYield() an unimportant race exists in updating time_yielded, such that time_yielded can be &lt; SCHEDULE_SLOTS</span>
<a name="l01742"></a>01742         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>&gt;=<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>
<a name="l01743"></a>01743 #<span class="keywordflow">else</span>
<a name="l01744"></a>01744         <a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#af93fc7d5896e3837002ea739b28acea0">time_yielded</a>
<a name="l01745"></a>01745 #endif
<a name="l01746"></a>01746         )){
<a name="l01747"></a>01747         <span class="comment">// we are yielding from a signal handler, return to same process</span>
<a name="l01748"></a>01748         next=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>;
<a name="l01749"></a>01749         <span class="comment">// Just returned from a signal handler and we have some time left in this slice.</span>
<a name="l01750"></a>01750         <span class="comment">// Reschedule this process to finish its slice.</span>
<a name="l01751"></a>01751         <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(next-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>==<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>,<span class="stringliteral">&quot;Returning from non-running signal handler.&quot;</span>);
<a name="l01752"></a>01752         <span class="comment">// do not reset the timeslice</span>
<a name="l01753"></a>01753         continue_slice=<span class="keyword">true</span>;
<a name="l01754"></a>01754         <span class="keywordflow">goto</span> have_proc;
<a name="l01755"></a>01755     }<span class="keywordflow">else</span>
<a name="l01756"></a>01756 <span class="preprocessor">#endif</span>
<a name="l01757"></a>01757 <span class="preprocessor"></span>    {
<a name="l01758"></a>01758         <span class="comment">// normal scheduling sequence</span>
<a name="l01759"></a>01759         next=<a class="code" href="kernel_8h.html#afa048712e8a413863369b93c18956d9b" title="currently running process">current_proc</a>-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>;
<a name="l01760"></a>01760         <span class="comment">// reset timeslice</span>
<a name="l01761"></a>01761         continue_slice=<span class="keyword">false</span>;
<a name="l01762"></a>01762     }
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     <span class="comment">// We have the first process to check whether we can context switch to,</span>
<a name="l01765"></a>01765     <span class="comment">// make sure this one is runnable.</span>
<a name="l01766"></a>01766     <span class="comment">// The loop below is only executed once, unless there are ZOMBIE or JOINABLE processes.</span>
<a name="l01767"></a>01767     <span class="comment">// So, ZOMBIE or JOINABLE processes take more time for a context switch, but save time</span>
<a name="l01768"></a>01768     <span class="comment">// because they are not scheduled at all. Concluded, the context switches per period takes at most</span>
<a name="l01769"></a>01769     <span class="comment">// (# of non-NOPROC) times (normal execution of context switch) time.</span>
<a name="l01770"></a>01770     <span class="comment">// Note that it is always a good idea to cleanup all non-RUNNING processes...</span>
<a name="l01771"></a>01771     <span class="keywordflow">while</span>(<a class="code" href="api_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(next!=NULL)){
<a name="l01772"></a>01772         <span class="keywordflow">switch</span>(next-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>){
<a name="l01773"></a>01773 <span class="preprocessor">#ifdef KERNEL_SIGNALS</span>
<a name="l01774"></a>01774 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1c2114335a42993ac5cc5dbf65f83d41" title="process waits for signal">SUSPENDED</a>:
<a name="l01775"></a>01775             <span class="keywordflow">if</span>(!next-&gt;<a class="code" href="struct__proc__table__t.html#acce8465a85099ffe0aa4fa8adf4117d8">sig_havetriggered</a>)
<a name="l01776"></a>01776                 <span class="keywordflow">break</span>;
<a name="l01777"></a>01777             next-&gt;<a class="code" href="struct__proc__table__t.html#ad3518e06cff711d1a2abca82e5ad5e0a" title="state of the process">state</a>=<a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>;
<a name="l01778"></a>01778 <span class="preprocessor">#endif</span>
<a name="l01779"></a>01779 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="kernel_8h.html#a59775280f5f039f80ce5d63993e40484a1061be6c3fb88d32829cba6f6b2be304" title="process has been started and can be scheduled">RUNNING</a>:
<a name="l01780"></a>01780             <span class="keywordflow">goto</span> have_proc;
<a name="l01781"></a>01781         <span class="keywordflow">default</span>:;
<a name="l01782"></a>01782         }
<a name="l01783"></a>01783         <span class="comment">// The next process in line was not able to continue, choose next one.</span>
<a name="l01784"></a>01784         <span class="comment">// This means that the slack is lost and the timeslice is reset.</span>
<a name="l01785"></a>01785         continue_slice=<span class="keyword">false</span>;
<a name="l01786"></a>01786         next=next-&gt;<a class="code" href="struct__proc__table__t.html#a4614cadd4f0ce34adbd6bd3c5966791c" title="next process, used for scheduling">next_entry</a>;
<a name="l01787"></a>01787     }
<a name="l01788"></a>01788     <a class="code" href="kernel_8cc.html#a73d4f21ad937dbc50a0c0538c78fd4f9">ASSERT</a>(<span class="keyword">false</span>,<span class="stringliteral">&quot;Broken scheduling sequence&quot;</span>);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 have_proc:
<a name="l01791"></a>01791 <span class="preprocessor">#ifdef SCHEDULE_SLOTS</span>
<a name="l01792"></a>01792 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(next==<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a> &amp;&amp; !continue_slice){
<a name="l01793"></a>01793         <span class="comment">// this is the start of a replenishment interval, replenish timeslice of task daemon</span>
<a name="l01794"></a>01794         <a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>-&gt;time_yielded=<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>-&gt;time;
<a name="l01795"></a>01795         <span class="comment">// next process to schedule is the normal one in line</span>
<a name="l01796"></a>01796         next-&gt;<a class="code" href="struct__proc__table__t.html#a460a06e7ca527ac72fd307f05c3950eb" title="previous process, used for scheduling">prev_entry</a>=NULL;
<a name="l01797"></a>01797     }
<a name="l01798"></a>01798     <span class="keywordflow">if</span>(switch_from_taskdaemon){
<a name="l01799"></a>01799         <span class="comment">// do not switch back the task daemon unless there is time left in its timeslice</span>
<a name="l01800"></a>01800         sch.<a class="code" href="structsch__t.html#ad37f09582d4fc75ff893686de8816a2a">skip_taskdaemon</a>=<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>-&gt;time_yielded&gt;<a class="code" href="helix__config_8h.html#a9b8ec775dba3342eb5f76fe54185eb8b" title="When defined, enable schedule slots, in cycles (must be power of two).">SCHEDULE_SLOTS</a>?0:1;
<a name="l01801"></a>01801         
<a name="l01802"></a>01802         <span class="keywordflow">if</span>(!switch_from_interrupting_taskdaemon)
<a name="l01803"></a>01803             <span class="comment">// end of schedule cycle, reset have_work</span>
<a name="l01804"></a>01804             sch.<a class="code" href="structsch__t.html#a4612ec2cb46cf0a82ca0a098996dec21">have_work</a>=<a class="code" href="kernel_8cc.html#a6646eba88004157f0b0e52925526488d">DID_WORK_NO</a>;
<a name="l01805"></a>01805     }
<a name="l01806"></a>01806     <span class="keywordflow">if</span>(next==<a class="code" href="kernel_8cc.html#ac626325ceddb5d49a930f1b435af28b4">td_proc</a>){
<a name="l01807"></a>01807         <span class="comment">// do not interrupt the task daemon to execute the task daemon</span>
<a name="l01808"></a>01808         sch.<a class="code" href="structsch__t.html#ad37f09582d4fc75ff893686de8816a2a">skip_taskdaemon</a>=1;
<a name="l01809"></a>01809     }
<a name="l01810"></a>01810 <span class="preprocessor">#endif</span>
<a name="l01811"></a>01811 <span class="preprocessor"></span>
<a name="l01812"></a>01812     <a class="code" href="kernel_8cc.html#a0f8a6392225c4e8fe2d9e6a6eee7811d">kScheduleProcess</a>(next,continue_slice);
<a name="l01813"></a>01813     <a class="code" href="kernel_8cc.html#ad7b6b6cb649dc9d9560c68b1d94464f9">DEBUG_OFF</a>(<a class="code" href="kernel_8cc.html#aa28741aad188fa566e089c3ea540a906">DBLED_SCHEDULE</a>);
<a name="l01814"></a>01814 }
<a name="l01815"></a>01815 
<a name="l01816"></a>01816 <span class="preprocessor">#ifdef __cplusplus</span>
<a name="l01817"></a>01817 <span class="preprocessor"></span>} <span class="comment">// extern &quot;C&quot;</span>
<a name="l01818"></a>01818 <span class="preprocessor">#endif</span>
<a name="l01819"></a>01819 <span class="preprocessor"></span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="kernel_8cc.html">kernel.cc</a>      </li>

    <li class="footer">Generated on Tue Apr 28 2015 16:39:18 for Starburst by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
